<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Generator Sertifikat Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Updated Google Fonts import to include more font families -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&family=Lora:wght@400;700&family=Merriweather:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Pacifico&family=Sacramento&family=Oswald:wght@400;700&family=Great+Vibes&family=Allura&family=Dancing+Script&family=Lato:wght@400;700&family=Poppins:wght@400;700&family=Crimson+Pro:wght@400;700&family=Bodoni+Moda:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> <!-- Added html2canvas for download -->
    <!-- New: jsPDF library for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-serif-display {
            font-family: 'Playfair Display', serif;
        }
        .canvas-container {
            aspect-ratio: 1.414 / 1; /* A4 paper ratio (approx) */
            width: 100%;
            max-width: 800px;
            margin: auto;
            position: relative; /* Needed for positioning draggable text elements */
        }
        canvas {
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
            background-color: #f0f0f0;
            cursor: grab; /* Default cursor for canvas */
        }
        .tab-button.active {
            background-color: #1d4ed8;
            color: white;
        }
        .template-thumbnail {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            height: 100px;
            border-radius: 0.375rem;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .template-thumbnail canvas,
        .template-thumbnail .overlay {
            display: block;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
        }
        .template-thumbnail .overlay {
            background-color: rgba(0,0,0,0.3);
            color: white;
            font-weight: 500;
            text-align: center;
            padding: 4px;
            font-size: 0.8rem;
            position: absolute;
            bottom: 0;
            width: 100%;
            pointer-events: none;
            z-index: 2;
        }
        .template-thumbnail.selected {
            border-color: #1d4ed8;
            transform: scale(1.05);
        }
        .logo-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            cursor: grab;
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-800">Generator Sertifikat Profesional</h1>
            <p class="text-gray-600 mt-2">Buat, kustomisasi, dan unduh sertifikat dengan mudah.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Kolom Kontrol -->
            <div class="bg-white p-6 rounded-lg shadow-md space-y-8">
                
                <!-- 1. Pemilihan Template -->
                <section>
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-blue-700">1. Pilih Template Sertifikat</h2>
                    <div class="flex border border-gray-300 rounded-lg p-1 bg-gray-50 mb-4">
                        <button id="tab-btn-provided" class="tab-button flex-1 p-2 rounded-md text-sm font-medium active">Template Kami</button>
                        <button id="tab-btn-upload" class="tab-button flex-1 p-2 rounded-md text-sm font-medium">Upload Gambar Template</button>
                    </div>
                    <div id="tab-content-provided">
                        <div id="template-thumbnails-container" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-60 overflow-y-auto pr-2">
                            <!-- Template thumbnails will be dynamically generated here -->
                        </div>
                    </div>
                    <div id="tab-content-upload" class="hidden">
                        <input type="file" id="template-upload-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                </section>

                <!-- 2. Kustomisasi Teks -->
                <section>
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-blue-700">2. Kustomisasi Teks</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="field-title" class="block text-sm font-medium text-gray-700">Judul Utama</label>
                            <input type="text" id="field-title" value="Sertifikat Penghargaan" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="field-subtitle" class="block text-sm font-medium text-gray-700">Sub-Judul</label>
                            <input type="text" id="field-subtitle" value="DIBERIKAN KEPADA" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label for="field-description" class="block text-sm font-medium text-gray-700">Deskripsi/Alasan Penghargaan</label>
                            <textarea id="field-description" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">Atas partisipasi dan kontribusi luar biasa dalam Workshop Pengembangan Aplikasi Web Interaktif.</textarea>
                        </div>
                        
                        <!-- NEW: Header Certificate Text Field -->
                        <div class="md:col-span-2">
                            <label for="field-header-certificate-text" class="block text-sm font-medium text-gray-700">Teks Header Sertifikat</label>
                            <input type="text" id="field-header-certificate-text" value="SERTIFIKAT" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>

                        <!-- Issuer 1 Fields -->
                        <div>
                            <label for="field-issuer" class="block text-sm font-medium text-gray-700">Nama Pemberi 1</label>
                            <input type="text" id="field-issuer" value="Sugandi,S.Kom" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="field-issuer-title" class="block text-sm font-medium text-gray-700">Jabatan Pemberi 1</label>
                            <input type="text" id="field-issuer-title" value="Direktur Program" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="field-issuer-nip" class="block text-sm font-medium text-gray-700">NIP Pemberi 1</label>
                            <input type="text" id="field-issuer-nip" value="1994xxxxxxxxxx1001" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>

                        <!-- Issuer 2 Fields -->
                        <div>
                            <label for="field-issuer2" class="block text-sm font-medium text-gray-700">Nama Pemberi 2</label>
                            <input type="text" id="field-issuer2" value="Prof. Siti Aminah" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="field-issuer-title2" class="block text-sm font-medium text-gray-700">Jabatan Pemberi 2</label>
                            <input type="text" id="field-issuer-title2" value="Kepala Departemen" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="field-issuer-nip2" class="block text-sm font-medium text-gray-700">NIP Pemberi 2</label>
                            <input type="text" id="field-issuer-nip2" value="198005152005022002" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>

                        <!-- Date Field -->
                        <div>
                            <label for="field-date" class="block text-sm font-medium text-gray-700">Tanggal Pelaksanaan</label>
                            <input type="text" id="field-date" value="27 Juni 2025" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                    <!-- New: Clear All Text Inputs button -->
                    <button id="clear-text-inputs-btn" class="mt-4 w-full bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition flex items-center justify-center gap-2">
                        <i class="fas fa-eraser"></i> Bersihkan Semua Input Teks
                    </button>
                </section>

                <!-- NEW: Back of Certificate Content -->
                <section>
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-blue-700">3. Konten Belakang Sertifikat</h2>
                    <p class="text-sm text-gray-600 mb-4">Isi tabel materi dan narasumber berikut. Maksimal 10 baris.</p>
                    <div class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Narasumber</label>
                                <input id="back-speaker-input" type="text" class="mt-1 w-full border rounded-md p-2 text-sm" placeholder="Nama Narasumber">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">Materi</label>
                                <input id="back-topic-input" type="text" class="mt-1 w-full border rounded-md p-2 text-sm" placeholder="Judul Materi">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Waktu</label>
                                <input id="back-time-input" type="text" class="mt-1 w-full border rounded-md p-2 text-sm" placeholder="08.00-10.00">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-2 items-end">
                            <div class="md:col-span-1">
                                <label class="block text-sm font-medium text-gray-700">JP</label>
                                <input id="back-hours-input" type="number" min="1" max="20" class="mt-1 w-full border rounded-md p-2 text-sm" placeholder="2">
                            </div>
                            <div class="md:col-span-3 flex justify-end mt-2 md:mt-0">
                                <button id="back-add-row-btn" type="button" class="px-3 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition flex items-center gap-2">
                                    <i class="fas fa-plus"></i>
                                    Tambah Sesi
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-center font-semibold text-gray-700 w-12">No</th>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-700">Narasumber</th>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-700">Materi</th>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-700 w-32">Waktu</th>
                                        <th class="px-3 py-2 text-center font-semibold text-gray-700 w-16">JP</th>
                                        <th class="px-3 py-2 text-center font-semibold text-gray-700 w-16">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="back-sessions-body" class="divide-y divide-gray-200">
                                    <!-- Baris sesi akan di-render oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-xs text-gray-500">Gunakan form di atas untuk menambah sesi (maks. 10 baris).</p>
                        </div>
                    </div>
                </section>

                <!-- 4. Data Penerima -->
                <section>
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-blue-700">4. Data Penerima Sertifikat</h2>
                    <div class="flex border border-gray-300 rounded-lg p-1 bg-gray-50 mb-4">
                        <button id="data-tab-manual" class="tab-button flex-1 p-2 rounded-md text-sm font-medium active">Input Manual</button>
                        <button id="data-tab-excel" class="tab-button flex-1 p-2 rounded-md text-sm font-medium">Import dari Excel</button>
                    </div>

                    <!-- Input Manual -->
                    <div id="data-content-manual">
                        <div class="space-y-3">
                            <div>
                                <label for="recipient-name" class="block text-sm font-medium text-gray-700">Nama Penerima</label>
                                <input type="text" id="recipient-name" placeholder="Contoh: Andi Wijaya" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="recipient-jabatan" class="block text-sm font-medium text-gray-700">Jabatan Penerima</label>
                                <input type="text" id="recipient-jabatan" placeholder="Contoh: Manajer Proyek" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="recipient-nip" class="block text-sm font-medium text-gray-700">NIP Penerima</label>
                                <input type="text" id="recipient-nip" placeholder="Contoh: 198510202010011005" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="recipient-nuptk" class="block text-sm font-medium text-gray-700">NUPTK Penerima</label>
                                <input type="text" id="recipient-nuptk" placeholder="Contoh: 1234567890123456" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <input type="hidden" id="editing-index">
                            </div>
                            <button id="add-recipient-btn" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700 transition flex items-center justify-center gap-2">
                                <i class="fas fa-plus-circle"></i> Tambah ke Daftar
                            </button>
                        </div>
                    </div>

                    <!-- Import Excel -->
                    <div id="data-content-excel" class="hidden">
                        <p class="text-sm text-gray-600 mb-2">Upload file .xlsx atau .xls. Pastikan kolom-kolom berikut sesuai urutan:</p>
                        <ul class="list-disc list-inside text-sm text-gray-600 mb-2">
                            <li>**Kolom A:** Nama Penerima</li>
                            <li>**Kolom B:** Jabatan Penerima</li>
                            <li>**Kolom C:** NIP Penerima</li>
                            <li>**Kolom D:** NUPTK Penerima</li>
                        </ul>
                        <button id="download-excel-template-btn" class="mb-2 w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition flex items-center justify-center gap-2">
                            <i class="fas fa-download"></i> Unduh Template Excel
                        </button>
                        <input type="file" id="excel-upload-input" accept=".xlsx, .xls" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                        <button id="import-excel-btn" class="mt-2 w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700 transition">Import Nama</button>
                    </div>

                    <!-- Daftar Penerima -->
                    <div class="mt-6">
                        <h3 class="font-semibold text-lg mb-2">Daftar Penerima</h3>
                        <div id="recipient-list-container" class="max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-lg border">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th scope="col" class="px-4 py-2">Nama</th>
                                        <th scope="col" class="px-4 py-2">Jabatan</th>
                                        <th scope="col" class="px-4 py-2">NIP</th>
                                        <th scope="col" class="px-4 py-2">NUPTK</th>
                                        <th scope="col" class="px-4 py-2 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="recipient-table-body">
                                    <!-- Data akan diisi oleh JavaScript -->
                                    <tr class="placeholder-row">
                                        <td colspan="5" class="text-center p-4 text-gray-400">Belum ada data penerima.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 5. Kelola Logo Instansi (New Section) -->
                <section>
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-blue-700">5. Kelola Logo Instansi</h2>
                    <div class="space-y-3">
                        <div>
                            <label for="logo-upload-input" class="block text-sm font-medium text-gray-700">Upload Logo (dari komputer)</label>
                            <input type="file" id="logo-upload-input" accept="image/*" multiple class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                        </div>
                        <div>
                            <label for="logo-url-input" class="block text-sm font-medium text-gray-700">Tambah Logo (dari URL)</label>
                            <div class="flex space-x-2">
                                <input type="text" id="logo-url-input" placeholder="Masukkan URL gambar logo..." class="flex-1 p-2 border rounded-md">
                                <button id="add-logo-url-btn" class="bg-purple-600 text-white p-2 rounded-md hover:bg-purple-700 transition">Tambah Logo</button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h3 class="font-semibold text-lg mb-2">Daftar Logo</h3>
                        <div id="logo-list-container" class="max-h-40 overflow-y-auto bg-gray-50 p-3 rounded-lg border flex flex-wrap gap-2">
                            <!-- Logo thumbnails will be appended here -->
                            <p class="text-center p-2 text-gray-400 w-full" id="no-logos-message">Belum ada logo ditambahkan.</p>
                        </div>
                    </div>
                </section>

            </div>

            <!-- Kolom Pratinjau -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4 text-center text-blue-700">Pratinjau Sertifikat</h2>
                <section id="element-controls-section" class="mb-6 hidden">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-blue-700">6. Kustomisasi Elemen Terpilih</h2>
                    <p id="element-selection-hint" class="text-gray-600 mb-4">Pilih teks atau logo di pratinjau untuk mengeditnya.</p>
                    <div id="font-controls" class="space-y-3 hidden">
                        <h3 class="font-semibold text-lg mb-2">Kontrol Teks</h3>
                        <div>
                            <label for="font-size-input" class="block text-sm font-medium text-gray-700">Ukuran Font</label>
                            <input type="number" id="font-size-input" min="10" max="200" value="30" class="mt-1 block w-full p-2 border rounded-md shadow-sm">
                        </div>
                        <div>
                            <input type="checkbox" id="font-weight-bold" class="mr-2">
                            <label for="font-weight-bold" class="text-sm font-medium text-gray-700">Tebal</label>
                        </div>
                        <div>
                            <label for="font-family-select" class="block text-sm font-medium text-gray-700">Jenis Font</label>
                            <select id="font-family-select" class="mt-1 block w-full p-2 border rounded-md shadow-sm">
                                <option value="Inter">Inter</option>
                                <option value="Playfair Display">Playfair Display</option>
                                <option value="Lora">Lora</option>
                                <option value="Merriweather">Merriweather</option>
                                <option value="Montserrat">Montserrat</option>
                                <option value="Open Sans">Open Sans</option>
                                <option value="Pacifico">Pacifico</option>
                                <option value="Sacramento">Sacramento</option>
                                <option value="Oswald">Oswald</option>
                                <option value="Great Vibes">Great Vibes</option>
                                <option value="Allura">Allura</option>
                                <option value="Dancing Script">Dancing Script</option>
                                <option value="Lato">Lato</option>
                                <option value="Poppins">Poppins</option>
                                <option value="Crimson Pro">Crimson Pro</option>
                                <option value="Bodoni Moda">Bodoni Moda</option>
                            </select>
                        </div>
                        <div>
                            <label for="text-color-input" class="block text-sm font-medium text-gray-700">Warna Teks</label>
                            <input type="color" id="text-color-input" value="#333333" class="mt-1 block w-full h-10 border rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="text-align-select" class="block text-sm font-medium text-gray-700">Perataan Teks</label>
                            <select id="text-align-select" class="mt-1 block w-full p-2 border rounded-md shadow-sm">
                                <option value="left">Kiri</option>
                                <option value="center">Tengah</option>
                                <option value="right">Kanan</option>
                            </select>
                        </div>
                        <div>
                            <label for="font-upload-input" class="block text-sm font-medium text-gray-700">Upload Font Kustom (.ttf, .otf, .woff)</label>
                            <input type="file" id="font-upload-input" accept=".ttf,.otf,.woff,.woff2" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                    </div>
                    <div id="image-controls" class="space-y-3 hidden">
                        <h3 class="font-semibold text-lg mb-2">Kontrol Gambar</h3>
                        <div>
                            <label for="image-width-input" class="block text-sm font-medium text-gray-700">Lebar Gambar</label>
                            <input type="number" id="image-width-input" min="10" max="1000" value="100" class="mt-1 block w-full p-2 border rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="image-height-input" class="block text-sm font-medium text-gray-700">Tinggi Gambar</label>
                            <input type="number" id="image-height-input" min="10" max="1000" value="100" class="mt-1 block w-full p-2 border rounded-md shadow-sm">
                        </div>
                    </div>
                </section>
                <div class="flex justify-center gap-4 mb-4">
                    <button id="view-front-btn" class="tab-button p-2 rounded-md text-sm font-medium active">Depan Sertifikat</button>
                    <button id="view-back-btn" class="tab-button p-2 rounded-md text-sm font-medium">Belakang Sertifikat</button>
                </div>
                <div class="canvas-container relative">
                    <canvas id="certificate-canvas" width="1123" height="794"></canvas>
                </div>
                <div class="mt-6 flex items-center justify-center gap-4">
                    <button id="prev-btn" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="preview-indicator" class="font-medium text-gray-700">Penerima 0 / 0</span>
                    <button id="next-btn" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="download-png-btn" class="w-full bg-blue-600 text-white p-3 text-lg font-bold rounded-md hover:bg-blue-700 transition flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-image"></i> Unduh PNG
                    </button>
                    <button id="download-pdf-btn" class="w-full bg-red-600 text-white p-3 text-lg font-bold rounded-md hover:bg-red-700 transition flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-file-pdf"></i> Unduh PDF
                    </button>
                </div>
                <!-- NEW: Download All as PDF button -->
                <div class="mt-4">
                    <button id="download-all-pdf-btn" class="w-full bg-indigo-600 text-white p-3 text-lg font-bold rounded-md hover:bg-indigo-700 transition flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-file-pdf"></i> Unduh Semua sebagai PDF
                    </button>
                </div>
                <div class="mt-4">
                    <button id="reset-all-data-btn" class="w-full bg-red-600 text-white p-3 text-lg font-bold rounded-md hover:bg-red-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-redo"></i> Reset Semua Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal Structure -->
    <div id="custom-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div id="custom-modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
            <p id="modal-message" class="text-gray-800 text-center mb-6 text-lg"></p>
            <div class="flex justify-center space-x-4">
                <button id="modal-ok-btn" class="bg-blue-600 text-white px-5 py-2 rounded-md hover:bg-blue-700 transition">Oke</button>
                <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-400 transition hidden">Batal</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === DOM ELEMENTS ===
            const canvas = document.getElementById('certificate-canvas');
            const ctx = canvas.getContext('2d');
            const canvasContainer = document.querySelector('.canvas-container');
            
            // Template controls
            const templateTabs = { provided: document.getElementById('tab-btn-provided'), upload: document.getElementById('tab-btn-upload') };
            const templateContents = { provided: document.getElementById('tab-content-provided'), upload: document.getElementById('tab-content-upload') };
            const templateThumbnailsContainer = document.getElementById('template-thumbnails-container');
            const templateUploadInput = document.getElementById('template-upload-input');

            // Text fields (input elements) - only for getting/setting content
            const textFields = {
                title: document.getElementById('field-title'),
                subtitle: document.getElementById('field-subtitle'),
                description: document.getElementById('field-description'),
                headerCertificateText: document.getElementById('field-header-certificate-text'),
                issuer: document.getElementById('field-issuer'),
                issuerTitle: document.getElementById('field-issuer-title'),
                issuerNip: document.getElementById('field-issuer-nip'),
                issuer2: document.getElementById('field-issuer2'),
                issuerTitle2: document.getElementById('field-issuer-title2'),
                issuerNip2: document.getElementById('field-issuer-nip2'),
                date: document.getElementById('field-date'),
            };

            // NEW: Back of Certificate Text Fields
            const backTextFields = {
                backMateri: document.getElementById('back-field-materi'),
                backNarasumber: document.getElementById('back-field-narasumber'),
                backJam: document.getElementById('back-field-jam'),
            };

            // Element controls (font/image)
            const elementControlsSection = document.getElementById('element-controls-section');
            const elementSelectionHint = document.getElementById('element-selection-hint');
            const fontControlsDiv = document.getElementById('font-controls');
            const imageControlsDiv = document.getElementById('image-controls');

            // Font controls
            const fontSizeInput = document.getElementById('font-size-input');
            const fontWeightBold = document.getElementById('font-weight-bold');
            const fontFamilySelect = document.getElementById('font-family-select');
            const textColorInput = document.getElementById('text-color-input');
            const textAlignSelect = document.getElementById('text-align-select');

            // New: Font Upload Input
            const fontUploadInput = document.getElementById('font-upload-input');

            // Image controls
            const imageWidthInput = document.getElementById('image-width-input');
            const imageHeightInput = document.getElementById('image-height-input');

            // Data controls - Re-introducing these elements as they are present in the provided index 15.html
            const dataTabs = { manual: document.getElementById('data-tab-manual'), excel: document.getElementById('data-tab-excel') };
            const dataContents = { manual: document.getElementById('data-content-manual'), excel: document.getElementById('data-content-excel') };
            const recipientNameInput = document.getElementById('recipient-name');
            const recipientJabatanInput = document.getElementById('recipient-jabatan');
            const recipientNipInput = document.getElementById('recipient-nip');
            const recipientNuptkInput = document.getElementById('recipient-nuptk');
            const addRecipientBtn = document.getElementById('add-recipient-btn');
            const editingIndexInput = document.getElementById('editing-index');
            const excelUploadInput = document.getElementById('excel-upload-input');
            const importExcelBtn = document.getElementById('import-excel-btn');
            const downloadExcelTemplateBtn = document.getElementById('download-excel-template-btn');
            const recipientTableBody = document.getElementById('recipient-table-body');
            
            // Logo controls
            const logoUploadInput = document.getElementById('logo-upload-input');
            const logoUrlInput = document.getElementById('logo-url-input');
            const addLogoUrlBtn = document.getElementById('add-logo-url-btn');
            const logoListContainer = document.getElementById('logo-list-container');
            const noLogosMessage = document.getElementById('no-logos-message');

            // Preview & Download
            const viewFrontBtn = document.getElementById('view-front-btn'); // NEW
            const viewBackBtn = document.getElementById('view-back-btn');   // NEW
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const previewIndicator = document.getElementById('preview-indicator');
            const downloadPngBtn = document.getElementById('download-png-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const downloadAllPdfBtn = document.getElementById('download-all-pdf-btn');
            const resetAllDataBtn = document.getElementById('reset-all-data-btn');
            const clearTextFieldsBtn = document.getElementById('clear-text-inputs-btn');

            // Back sessions table DOM
            const backSessionsBody = document.getElementById('back-sessions-body');
            const backAddRowBtn = document.getElementById('back-add-row-btn');
            const backSpeakerInputEl = document.getElementById('back-speaker-input');
            const backTopicInputEl = document.getElementById('back-topic-input');
            const backTimeInputEl = document.getElementById('back-time-input');
            const backHoursInputEl = document.getElementById('back-hours-input');

            // Custom Modal Elements
            const customModalOverlay = document.getElementById('custom-modal-overlay');
            const modalMessage = document.getElementById('modal-message');
            const modalOkBtn = document.getElementById('modal-ok-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');


            // === STATE ===
            let recipients = [];
            let nextSerialNumber = 1;
            let backSessions = [];
            let backEditingIndex = -1;

            let currentRecipientIndex = -1;
            let currentTemplateId = 'professional'; // Default template ID
            let templateImage = new Image();
            templateImage.crossOrigin = "Anonymous";
            let isCustomImageLoaded = false; // True if an image was uploaded, false if using code-drawn templates
            let nextLogoId = 0;

            let draggableElements = []; // Array of {id, type, x, y, view, ...}
            let draggedElement = null;
            let dragStartX, dragStartY;
            let elementStartX, elementStartY;
            let selectedDraggableElement = null;
            let isDownloading = false;
            let currentView = 'front'; // 'front' or 'back' // NEW

            const LOCAL_STORAGE_KEY = 'certificateGeneratorState';
            const SERIAL_PREFIX = 'INST-2025-';

            // === Helper functions (hoisted) ===
            function showModal(message, confirm = false) {
                return new Promise((resolve) => {
                    const overlay = document.getElementById('custom-modal-overlay');
                    const msg = document.getElementById('modal-message');
                    const ok = document.getElementById('modal-ok-btn');
                    const cancel = document.getElementById('modal-cancel-btn');
                    if (!overlay || !msg || !ok || !cancel) {
                        if (confirm) resolve(window.confirm(message || 'Lanjutkan?'));
                        else { window.alert(message || 'Info'); resolve(true); }
                        return;
                    }
                    msg.textContent = message || '';
                    overlay.classList.remove('hidden');
                    if (confirm) cancel.classList.remove('hidden'); else cancel.classList.add('hidden');
                    const cleanup = () => {
                        overlay.classList.add('hidden');
                        ok.onclick = null; cancel.onclick = null;
                    };
                    ok.onclick = () => { cleanup(); resolve(true); };
                    cancel.onclick = () => { cleanup(); resolve(false); };
                });
            }

            function showLoading(flag) {
                document.body.style.cursor = flag ? 'progress' : 'default';
            }

            function generateSerial() {
                const num = String(nextSerialNumber++).padStart(4, '0');
                return `${SERIAL_PREFIX}${num}`;
            }

            function drawTemplateBackground(templateId) {
                const tpl = (hardcodedTemplates || []).find(t => t.id === templateId) || hardcodedTemplates[0];
                if (tpl && typeof tpl.draw === 'function') tpl.draw(ctx, canvas.width, canvas.height);
            }

            function selectProvidedTemplate(templateId) {
                currentTemplateId = templateId;
                isCustomImageLoaded = false;
                templateImage.src = '';
                drawCertificate();
                saveState();
                if (templateThumbnailsContainer) {
                    Array.from(templateThumbnailsContainer.querySelectorAll('.template-thumbnail')).forEach(el => {
                        el.classList.toggle('selected', el.dataset.id === templateId);
                    });
                }
            }

            function selectCustomTemplateImage(src) {
                isCustomImageLoaded = true;
                templateImage.onload = () => { drawCertificate(); saveState(); };
                templateImage.onerror = () => { isCustomImageLoaded = false; showModal('Gambar template gagal dimuat.'); };
                templateImage.src = src;
            }

            function switchTab(tabs, activeKey, contents) {
                Object.entries(tabs).forEach(([key, btn]) => {
                    if (!btn) return; btn.classList.toggle('active', key === activeKey);
                });
                Object.entries(contents).forEach(([key, el]) => {
                    if (!el) return; el.classList.toggle('hidden', key !== activeKey);
                });
            }

            // Ensure the sidebar controls reflect current selection and view
            function updateSidebarControls() {
                if (!elementControlsSection || !elementSelectionHint || !fontControlsDiv || !imageControlsDiv) return;

                if (currentView !== 'front') {
                    elementControlsSection.classList.add('hidden');
                    return;
                }

                elementControlsSection.classList.remove('hidden');

                if (!selectedDraggableElement) {
                    elementSelectionHint.classList.remove('hidden');
                    fontControlsDiv.classList.add('hidden');
                    imageControlsDiv.classList.add('hidden');
                    return;
                }

                elementSelectionHint.classList.add('hidden');
                if (selectedDraggableElement.type === 'text') {
                    fontControlsDiv.classList.remove('hidden');
                    imageControlsDiv.classList.add('hidden');

                    if (fontSizeInput && typeof selectedDraggableElement.fontSize === 'number') {
                        fontSizeInput.value = String(selectedDraggableElement.fontSize);
                    }
                    if (fontFamilySelect && selectedDraggableElement.fontFamily) {
                        const exists = Array.from(fontFamilySelect.options).some(o => o.value === selectedDraggableElement.fontFamily);
                        if (exists) fontFamilySelect.value = selectedDraggableElement.fontFamily;
                    }
                    if (textColorInput && selectedDraggableElement.color) {
                        textColorInput.value = selectedDraggableElement.color;
                    }
                    if (textAlignSelect && selectedDraggableElement.textAlign) {
                        textAlignSelect.value = selectedDraggableElement.textAlign;
                    }
                    if (fontWeightBold) {
                        fontWeightBold.checked = (selectedDraggableElement.fontStyle || '').toLowerCase().includes('bold');
                    }
                } else if (selectedDraggableElement.type === 'image') {
                    imageControlsDiv.classList.remove('hidden');
                    fontControlsDiv.classList.add('hidden');

                    if (imageWidthInput && typeof selectedDraggableElement.width === 'number') {
                        imageWidthInput.value = String(selectedDraggableElement.width);
                    }
                    if (imageHeightInput && typeof selectedDraggableElement.height === 'number') {
                        imageHeightInput.value = String(selectedDraggableElement.height);
                    }
                } else {
                    fontControlsDiv.classList.add('hidden');
                    imageControlsDiv.classList.add('hidden');
                }
            }

            function updateUI() {
                if (!elementControlsSection) return;
                if (currentView === 'front') {
                    elementControlsSection.classList.remove('hidden');
                } else {
                    elementControlsSection.classList.add('hidden');
                }
                updateViewButtonsActive();
                updateSidebarControls();
            }

            function updateViewButtonsActive() {
                if (!viewFrontBtn || !viewBackBtn) return;
                viewFrontBtn.classList.toggle('active', currentView === 'front');
                viewBackBtn.classList.toggle('active', currentView === 'back');
            }

            function renderRecipientTable() {
                if (!recipientTableBody) return;
                recipientTableBody.innerHTML = '';
                if (recipients.length === 0) {
                    const tr = document.createElement('tr');
                    tr.className = 'placeholder-row';
                    const td = document.createElement('td');
                    td.colSpan = 5; td.className = 'text-center p-4 text-gray-400';
                    td.textContent = 'Belum ada data penerima.'; tr.appendChild(td);
                    recipientTableBody.appendChild(tr);
                    updateRecipientIndicator();
                    return;
                }
                recipients.forEach((rec, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-2">${rec.name}</td>
                        <td class="px-4 py-2">${rec.jabatan || ''}</td>
                        <td class="px-4 py-2">${rec.nip || ''}</td>
                        <td class="px-4 py-2">${rec.nuptk || ''}</td>
                        <td class="px-4 py-2 text-center">
                          <button class="text-blue-600 hover:underline btn-edit" data-index="${idx}">Edit</button>
                          <span class="mx-1">|</span>
                          <button class="text-red-600 hover:underline btn-delete" data-index="${idx}">Hapus</button>
                        </td>`;
                    recipientTableBody.appendChild(tr);
                });
                if (typeof handleEdit === 'function') recipientTableBody.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', handleEdit));
                if (typeof handleDelete === 'function') recipientTableBody.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', handleDelete));
                updateRecipientIndicator();
            }

            function updateRecipientIndicator() {
                if (!previewIndicator) return;
                const total = recipients.length;
                const current = currentRecipientIndex >= 0 ? currentRecipientIndex + 1 : 0;
                previewIndicator.textContent = `Penerima ${current} / ${total}`;
                if (prevBtn) prevBtn.disabled = currentRecipientIndex <= 0;
                if (nextBtn) nextBtn.disabled = currentRecipientIndex >= total - 1 || total === 0;
            }

            function renderLogoThumbnails() {
                if (!logoListContainer) return;
                const logos = draggableElements.filter(el => el.type === 'image');
                logoListContainer.innerHTML = '';
                if (logos.length === 0) { if (noLogosMessage) noLogosMessage.classList.remove('hidden'); return; }
                if (noLogosMessage) noLogosMessage.classList.add('hidden');
                logos.forEach(logo => {
                    const wrapper = document.createElement('div'); wrapper.className = 'relative';
                    const img = document.createElement('img'); img.src = logo.src; img.className = 'logo-thumbnail';
                    const del = document.createElement('button'); del.textContent = 'Hapus'; del.className = 'absolute -bottom-2 left-1/2 -translate-x-1/2 text-xs text-white bg-red-600 px-1.5 py-0.5 rounded'; del.dataset.id = logo.id; del.addEventListener('click', handleDeleteLogo);
                    wrapper.appendChild(img); wrapper.appendChild(del); logoListContainer.appendChild(wrapper);
                });
            }

            function renderTemplateThumbnails() {
                if (!templateThumbnailsContainer) return;
                templateThumbnailsContainer.innerHTML = '';
                (hardcodedTemplates || []).forEach(tpl => {
                    const div = document.createElement('div');
                    div.className = 'template-thumbnail bg-gray-200';
                    div.dataset.id = tpl.id;
                    div.style.cursor = 'pointer';
                    div.setAttribute('role', 'button');
                    div.setAttribute('tabindex', '0');

                    const thumbCanvas = document.createElement('canvas');
                    // Set a fixed internal resolution for crisp preview, CSS will scale
                    thumbCanvas.width = 280;
                    thumbCanvas.height = 180;
                    thumbCanvas.style.width = '100%';
                    thumbCanvas.style.height = '100%';
                    thumbCanvas.style.display = 'block';
                    const tctx = thumbCanvas.getContext('2d');
                    // Fill background white to avoid transparency
                    tctx.fillStyle = '#ffffff';
                    tctx.fillRect(0, 0, thumbCanvas.width, thumbCanvas.height);
                    try {
                        if (tpl && typeof tpl.draw === 'function') tpl.draw(tctx, thumbCanvas.width, thumbCanvas.height);
                    } catch (e) {
                        // ignore drawing error in thumbnail
                    }

                    const overlay = document.createElement('div');
                    overlay.className = 'overlay';
                    overlay.textContent = tpl.name;
                    overlay.style.pointerEvents = 'none';

                    div.appendChild(thumbCanvas);
                    div.appendChild(overlay);
                    if (tpl.id === currentTemplateId) div.classList.add('selected');
                    templateThumbnailsContainer.appendChild(div);
                });
                // Event delegation: ensure any click inside a card selects the template precisely
                templateThumbnailsContainer.onclick = (ev) => {
                    const card = ev.target.closest('.template-thumbnail');
                    if (!card || !templateThumbnailsContainer.contains(card)) return;
                    const id = card.dataset.id;
                    if (id) selectProvidedTemplate(id);
                };
                // Keyboard support
                templateThumbnailsContainer.onkeydown = (ev) => {
                    if (ev.key !== 'Enter' && ev.key !== ' ') return;
                    const card = ev.target.closest('.template-thumbnail');
                    if (!card) return;
                    ev.preventDefault();
                    const id = card.dataset.id;
                    if (id) selectProvidedTemplate(id);
                };
            }

            function renderBackSessionsTable() {
                if (!backSessionsBody) return;
                backSessionsBody.innerHTML = '';
                if (!Array.isArray(backSessions) || backSessions.length === 0) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 6;
                    td.className = 'px-4 py-3 text-center text-gray-400';
                    td.textContent = 'Belum ada sesi ditambahkan.';
                    tr.appendChild(td);
                    backSessionsBody.appendChild(tr);
                    return;
                }
                backSessions.forEach((s, idx) => {
                    const tr = document.createElement('tr');
                    tr.dataset.index = String(idx);
                    tr.className = 'row-session';
                    tr.innerHTML = `
                        <td class="px-3 py-2 text-center">${idx + 1}</td>
                        <td class="px-3 py-2">${s.speaker || ''}</td>
                        <td class="px-3 py-2">${s.topic || ''}</td>
                        <td class="px-3 py-2">${s.time || ''}</td>
                        <td class="px-3 py-2 text-center">${s.hours || ''}</td>
                        <td class="px-3 py-2 text-center">
                            <button class="text-blue-600 hover:underline btn-edit-session" data-index="${idx}">Edit</button>
                            <span class="mx-1">|</span>
                            <button class="text-red-600 hover:underline btn-del-session" data-index="${idx}">Hapus</button>
                        </td>`;
                    backSessionsBody.appendChild(tr);
                    // Row click to edit (ignore clicks on buttons)
                    tr.addEventListener('click', (ev) => {
                        if (ev.target.closest('button')) return;
                        const i = parseInt(tr.dataset.index, 10);
                        if (!isNaN(i) && backSessions[i]) {
                            const s = backSessions[i];
                            if (backSpeakerInputEl) backSpeakerInputEl.value = s.speaker || '';
                            if (backTopicInputEl) backTopicInputEl.value = s.topic || '';
                            if (backTimeInputEl) backTimeInputEl.value = s.time || '';
                            if (backHoursInputEl) backHoursInputEl.value = s.hours === '' ? '' : String(s.hours);
                            backEditingIndex = i;
                            if (backAddRowBtn) backAddRowBtn.innerHTML = '<i class="fas fa-save"></i> Perbarui Sesi';
                            updateBackAddButtonState();
                            saveState();
                        }
                    });
                });
                // Append Total JP row
                const totalJp = backSessions.reduce((sum, s) => sum + (Number(s.hours) || 0), 0);
                const trTotal = document.createElement('tr');
                trTotal.className = 'bg-gray-50';
                trTotal.innerHTML = `
                    <td class="px-3 py-2 text-right font-semibold" colspan="4">Total JP</td>
                    <td class="px-3 py-2 text-center font-semibold">${totalJp}</td>
                    <td class="px-3 py-2"></td>`;
                backSessionsBody.appendChild(trTotal);
                backSessionsBody.querySelectorAll('.btn-del-session').forEach(btn => btn.addEventListener('click', (e) => {
                    const i = parseInt(e.currentTarget.dataset.index, 10);
                    if (!isNaN(i)) {
                        backSessions.splice(i, 1);
                        if (backEditingIndex === i) {
                            backEditingIndex = -1;
                            if (backSpeakerInputEl) backSpeakerInputEl.value = '';
                            if (backTopicInputEl) backTopicInputEl.value = '';
                            if (backTimeInputEl) backTimeInputEl.value = '';
                            if (backHoursInputEl) backHoursInputEl.value = '';
                            if (backAddRowBtn) backAddRowBtn.innerHTML = '<i class="fas fa-plus"></i> Tambah Sesi';
                        } else if (backEditingIndex > i) {
                            backEditingIndex -= 1;
                        }
                        renderBackSessionsTable();
                        if (currentView === 'back') drawCertificate();
                        saveState();
                        updateBackAddButtonState();
                    }
                }));
                backSessionsBody.querySelectorAll('.btn-edit-session').forEach(btn => btn.addEventListener('click', (e) => {
                    const i = parseInt(e.currentTarget.dataset.index, 10);
                    if (!isNaN(i) && backSessions[i]) {
                        const s = backSessions[i];
                        if (backSpeakerInputEl) backSpeakerInputEl.value = s.speaker || '';
                        if (backTopicInputEl) backTopicInputEl.value = s.topic || '';
                        if (backTimeInputEl) backTimeInputEl.value = s.time || '';
                        if (backHoursInputEl) backHoursInputEl.value = s.hours === '' ? '' : String(s.hours);
                        backEditingIndex = i;
                        if (backAddRowBtn) backAddRowBtn.innerHTML = '<i class="fas fa-save"></i> Perbarui Sesi';
                        updateBackAddButtonState();
                        saveState();
                    }
                }));
            }

            function updateBackAddButtonState() {
                if (!backAddRowBtn) return;
                const disabled = Array.isArray(backSessions) && backSessions.length >= 10 && backEditingIndex === -1;
                backAddRowBtn.disabled = disabled;
                if (disabled) backAddRowBtn.classList.add('opacity-50', 'cursor-not-allowed');
                else backAddRowBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            // Handle add session for back page table
            function addBackSession() {
                if (!backSpeakerInputEl || !backTopicInputEl || !backTimeInputEl || !backHoursInputEl) return;
                if (!Array.isArray(backSessions)) backSessions = [];

                // Limit rows
                if (backSessions.length >= 10 && backEditingIndex === -1) {
                    showModal('Maksimal 10 sesi. Hapus salah satu untuk menambah yang baru.');
                    return;
                }

                const speaker = (backSpeakerInputEl.value || '').trim();
                const topic = (backTopicInputEl.value || '').trim();
                const time = (backTimeInputEl.value || '').trim();
                const hoursStr = (backHoursInputEl.value || '').trim();
                const hours = hoursStr === '' ? '' : Number(hoursStr);

                if (!speaker || !topic || !time) {
                    showModal('Lengkapi Narasumber, Materi, dan Waktu.');
                    return;
                }
                if (hoursStr !== '' && (isNaN(hours) || hours <= 0)) {
                    showModal('JP harus berupa angka positif.');
                    return;
                }
                if (backEditingIndex >= 0 && backEditingIndex < backSessions.length) {
                    backSessions[backEditingIndex] = { speaker, topic, time, hours: hoursStr === '' ? '' : hours };
                    backEditingIndex = -1;
                    if (backAddRowBtn) backAddRowBtn.textContent = '+ Tambah Sesi';
                } else {
                    backSessions.push({ speaker, topic, time, hours: hoursStr === '' ? '' : hours });
                }
                renderBackSessionsTable();
                updateBackAddButtonState();
                saveState();

                // Clear inputs
                backSpeakerInputEl.value = '';
                backTopicInputEl.value = '';
                backTimeInputEl.value = '';
                backHoursInputEl.value = '';

                if (currentView === 'back') drawCertificate();
            }

            if (backAddRowBtn) {
                backAddRowBtn.addEventListener('click', addBackSession);
            }

            function saveState() {
                try {
                    const state = {
                        recipients,
                        nextSerialNumber,
                        currentRecipientIndex,
                        currentTemplateId,
                        isCustomImageLoaded,
                        templateImageSrc: templateImage.src || '',
                        draggableElements: draggableElements.map(el => el.type === 'image' ? { ...el, image: undefined } : el),
                        backSessions,
                        backEditingIndex,
                    };

                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
                } catch (e) { /* ignore */ }
            }

            async function loadState() {
                try {
                    const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (!raw) { initializeDefaultState(); return; }
                    const state = JSON.parse(raw);
                    recipients = Array.isArray(state.recipients) ? state.recipients : [];
                    nextSerialNumber = state.nextSerialNumber || 1;
                    currentRecipientIndex = typeof state.currentRecipientIndex === 'number' ? state.currentRecipientIndex : (recipients.length > 0 ? 0 : -1);
                    currentTemplateId = state.currentTemplateId || 'professional';
                    isCustomImageLoaded = !!state.isCustomImageLoaded;
                    draggableElements = Array.isArray(state.draggableElements) ? state.draggableElements : defaultDraggableTextElements;
                    backSessions = Array.isArray(state.backSessions) ? state.backSessions : [];
                    backEditingIndex = typeof state.backEditingIndex === 'number' ? state.backEditingIndex : -1;

                    if (isCustomImageLoaded && state.templateImageSrc) {
                        selectCustomTemplateImage(state.templateImageSrc);
                    } else {
                        drawCertificate();
                    }
                    renderRecipientTable();
                    renderLogoThumbnails();
                    renderBackSessionsTable();
                    renderTemplateThumbnails();
                    updateUI();
                    updateBackAddButtonState();
                } catch (e) {
                    initializeDefaultState();
                }
            }

            // Initial default draggable text elements definition (used for fresh start/reset)
            // Added 'view' property to specify which side of the certificate the element belongs to
            const defaultDraggableTextElements = [
                // Front of Certificate Elements
                { id: 'title', type: 'text', content: '', x: 1123 / 2, y: 100, fontSize: 70, fontStyle: 'bold', fontFamily: 'Playfair Display', color: '#333333', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 - 200, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'subtitle', type: 'text', content: '', x: 1123 / 2, y: 200, fontSize: 30, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 - 200, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'recipientName', type: 'text', content: '', x: 1123 / 2, y: 300, fontSize: 90, fontStyle: 'bold', fontFamily: 'Playfair Display', color: '#0d3d75', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 - 200, lineHeightMultiplier: 0.9, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'recipientJabatan', type: 'text', content: '', x: 1123 / 2, y: 350, fontSize: 28, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 - 200, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true }, 
                { id: 'recipientNip', type: 'text', content: '', x: 1123 / 2, y: 390, fontSize: 24, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 - 200, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'recipientNuptk', type: 'text', content: '', x: 1123 / 2, y: 430, fontSize: 24, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 - 200, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'description', type: 'text', content: '', x: 1123 / 2, y: 450, fontSize: 24, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'center', textBaseline: 'top', maxWidth: 1123 - 250, lineHeightMultiplier: 1.1, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'headerCertificateText', type: 'text', content: 'SERTIFIKAT', x: 1123 / 2, y: 220, fontSize: 50, fontStyle: 'bold', fontFamily: 'Inter', color: '#FFFFFF', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 - 200, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'issuer', type: 'text', content: '', x: 1123 / 4, y: 660, fontSize: 30, fontStyle: 'bold', fontFamily: 'Inter', color: '#333333', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 / 2 - 100, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'issuerTitle', type: 'text', content: '', x: 1123 / 4, y: 690, fontSize: 24, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 / 2 - 100, lineHeightMultiplier: 1.2, fixedRelative: 'issuer', isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'issuerNip', type: 'text', content: '', x: 1123 / 4, y: 720, fontSize: 20, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 / 2 - 100, lineHeightMultiplier: 1.2, fixedRelative: 'issuerTitle', isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'date', type: 'text', content: '', x: 1123 - 150, y: 150, fontSize: 24, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'right', textBaseline: 'alphabetic', maxWidth: 200, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'dateLabel', type: 'text', content: 'Tanggal', x: 1123 - 150, y: 180, fontSize: 20, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'right', textBaseline: 'alphabetic', maxWidth: 200, lineHeightMultiplier: 1.2, fixedRelative: 'date', isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'issuer2', type: 'text', content: '', x: 1123 * 3 / 4, y: 660, fontSize: 30, fontStyle: 'bold', fontFamily: 'Inter', color: '#333333', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 / 2 - 100, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'issuerTitle2', type: 'text', content: '', x: 1123 * 3 / 4, y: 690, fontSize: 24, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 / 2 - 100, lineHeightMultiplier: 1.2, fixedRelative: 'issuer2', isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'issuerNip2', type: 'text', content: '', x: 1123 * 3 / 4, y: 720, fontSize: 20, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 / 2 - 100, lineHeightMultiplier: 1.2, fixedRelative: 'issuerTitle2', isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'serialNumber', type: 'text', content: 'INST-2025-0001', x: 150, y: 740, fontSize: 20, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'left', textBaseline: 'alphabetic', maxWidth: 300, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'front', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
            
                // Back of Certificate Elements (NEW)
                { id: 'backHeader', type: 'text', content: 'Materi & Narasumber', x: 1123 / 2, y: 100, fontSize: 48, fontStyle: 'bold', fontFamily: 'Inter', color: '#333333', textAlign: 'center', textBaseline: 'alphabetic', maxWidth: 1123 - 200, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'back', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'backMateriTitle', type: 'text', content: 'Materi:', x: 100, y: 200, fontSize: 30, fontStyle: 'bold', fontFamily: 'Inter', color: '#555555', textAlign: 'left', textBaseline: 'alphabetic', maxWidth: 1123 - 200, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'back', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'backMateri', type: 'text', content: '', x: 100, y: 240, fontSize: 24, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'left', textBaseline: 'top', maxWidth: 1123 - 200, lineHeightMultiplier: 1.3, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'back', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'backNarasumberTitle', type: 'text', content: 'Narasumber:', x: 100, y: 450, fontSize: 30, fontStyle: 'bold', fontFamily: 'Inter', color: '#555555', textAlign: 'left', textBaseline: 'alphabetic', maxWidth: 1123 - 200, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'back', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'backNarasumber', type: 'text', content: '', x: 100, y: 490, fontSize: 24, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'left', textBaseline: 'top', maxWidth: 1123 - 200, lineHeightMultiplier: 1.3, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'back', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'backJamTitle', type: 'text', content: 'Jam Pelaksanaan:', x: 100, y: 650, fontSize: 30, fontStyle: 'bold', fontFamily: 'Inter', color: '#555555', textAlign: 'left', textBaseline: 'alphabetic', maxWidth: 1123 - 200, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'back', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
                { id: 'backJam', type: 'text', content: '', x: 100, y: 690, fontSize: 24, fontStyle: 'normal', fontFamily: 'Inter', color: '#555555', textAlign: 'left', textBaseline: 'alphabetic', maxWidth: 1123 - 200, lineHeightMultiplier: 1.2, isColorCustomized: false, isFontFamilyCustomized: false, isFontSizeCustomized: false, isAlignCustomized: false, isPositionCustomized: false, view: 'back', calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true },
            ];

            // All available templates (hardcoded only)
            let allTemplates = [];

            // Define hardcoded templates here (reduced to 3)
            const hardcodedTemplates = [
                {
                    id: 'professional',
                    name: 'Profesional',
                    initialHeaderColor: '#FFFFFF',
                    initialBodyColor: '#E0E0E0',
                    initialRecipientNameColor: '#0d3d75', // Changed to a darker blue
                    draw: function(ctx, w, h) {
                        ctx.fillStyle = '#f0f4f8';
                        ctx.fillRect(0, 0, w, h);
                        ctx.fillStyle = '#0a2e5c';
                        ctx.fillRect(0, 0, w, h * 0.15);
                        ctx.fillRect(0, h * 0.85, w, h * 0.15);
                        ctx.fillStyle = '#d4af37';
                        ctx.fillRect(0, h * 0.15, w, 5);
                        ctx.fillRect(0, h * 0.85 - 5, w, 5);
                        ctx.font = '50px Inter';
                        ctx.fillStyle = '#d4af37';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'alphabetic';
                        ctx.fillText('', 40, 75);
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'alphabetic';
                        ctx.fillText('', w - 40, 75);
                    }
                },
                {
                    id: 'modern',
                    name: 'Modern',
                    initialHeaderColor: '#FFFFFF',
                    initialBodyColor: '#E0E0E0',
                    initialRecipientNameColor: '#00ffff',
                    draw: function(ctx, w, h) {
                        const gradientModern = ctx.createLinearGradient(0, 0, w, h);
                        gradientModern.addColorStop(0, '#4f46e5');
                        gradientModern.addColorStop(1, '#c026d3');
                        ctx.fillStyle = gradientModern;
                        ctx.fillRect(0, 0, w, h);
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                        ctx.beginPath();
                        ctx.moveTo(0, h * 0.7);
                        ctx.bezierCurveTo(w * 0.25, h * 0.6, w * 0.3, h * 0.8, w * 0.5, h * 0.75);
                        ctx.bezierCurveTo(w * 0.75, h * 0.7, w * 0.8, h * 0.9, w, h * 0.8);
                        ctx.lineTo(w, h);
                        ctx.lineTo(0, h);
                        ctx.closePath();
                        ctx.fill();
                    }
                },
                {
                    id: 'formal',
                    name: 'Formal',
                    initialHeaderColor: '#333333',
                    initialBodyColor: '#555555',
                    initialRecipientNameColor: '#0d3d75',
                    draw: function(ctx, w, h) {
                        ctx.fillStyle = '#fdfbf4';
                        ctx.fillRect(0, 0, w, h);
                        ctx.strokeStyle = '#a88e69';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(20, 20, w-40, h-40);
                        ctx.strokeRect(30, 30, w-60, h-60);
                    }
                },
                {
                    id: 'minimalist',
                    name: 'Minimalis',
                    initialHeaderColor: '#111827',
                    initialBodyColor: '#F3F4F6',
                    initialRecipientNameColor: '#2563eb',
                    draw: function(ctx, w, h) {
                        // Background subtle gray
                        ctx.fillStyle = '#F9FAFB';
                        ctx.fillRect(0, 0, w, h);
                        // Top bar
                        ctx.fillStyle = '#111827';
                        ctx.fillRect(0, 0, w, 12);
                        // Thin border
                        ctx.strokeStyle = '#E5E7EB';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(18, 18, w - 36, h - 36);
                        // Accent circle
                        ctx.fillStyle = '#2563eb';
                        ctx.beginPath();
                        ctx.arc(w - 70, 60, 6, 0, Math.PI * 2);
                        ctx.fill();
                    }
                },
                {
                    id: 'elegant',
                    name: 'Elegan',
                    initialHeaderColor: '#a88734',
                    initialBodyColor: '#f7f2e7',
                    initialRecipientNameColor: '#7c5a27',
                    draw: function(ctx, w, h) {
                        // Cream paper
                        ctx.fillStyle = '#f7f2e7';
                        ctx.fillRect(0, 0, w, h);
                        // Double gold border
                        ctx.strokeStyle = '#c5a66e';
                        ctx.lineWidth = 4;
                        ctx.strokeRect(22, 22, w - 44, h - 44);
                        ctx.strokeStyle = '#a88734';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(40, 40, w - 80, h - 80);
                        // Corner ornament arcs
                        ctx.strokeStyle = '#c5a66e';
                        ctx.lineWidth = 1.5;
                        const r = 28;
                        ctx.beginPath(); ctx.arc(68, 68, r, Math.PI, 1.5*Math.PI); ctx.stroke();
                        ctx.beginPath(); ctx.arc(w-68, 68, r, 1.5*Math.PI, 0); ctx.stroke();
                        ctx.beginPath(); ctx.arc(68, h-68, r, 0.5*Math.PI, Math.PI); ctx.stroke();
                        ctx.beginPath(); ctx.arc(w-68, h-68, r, 0, 0.5*Math.PI); ctx.stroke();
                    }
                },
                {
                    id: 'tech',
                    name: 'Tech',
                    initialHeaderColor: '#111827',
                    initialBodyColor: '#0ea5e9',
                    initialRecipientNameColor: '#22d3ee',
                    draw: function(ctx, w, h) {
                        // Bold diagonal split with cyan accents
                        const g = ctx.createLinearGradient(0, 0, w, h);
                        g.addColorStop(0, '#111827');
                        g.addColorStop(1, '#0f172a');
                        ctx.fillStyle = g;
                        ctx.fillRect(0, 0, w, h);
                        // Cyan diagonal shape
                        ctx.fillStyle = '#06b6d4';
                        ctx.beginPath();
                        ctx.moveTo(0, h * 0.25);
                        ctx.lineTo(w * 0.6, 0);
                        ctx.lineTo(w, 0);
                        ctx.lineTo(w, h * 0.2);
                        ctx.lineTo(w * 0.35, h * 0.45);
                        ctx.closePath();
                        ctx.fill();
                        // Accent dots
                        ctx.fillStyle = 'rgba(255,255,255,0.15)';
                        for (let i = 0; i < 50; i++) {
                            const x = Math.random() * w;
                            const y = Math.random() * h;
                            ctx.beginPath();
                            ctx.arc(x, y, 1.2, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                },
                {
                    id: 'classic-blue',
                    name: 'Klasik Biru',
                    initialHeaderColor: '#1e3a8a',
                    initialBodyColor: '#f8fafc',
                    initialRecipientNameColor: '#1e3a8a',
                    draw: function(ctx, w, h) {
                        // White background
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, w, h);
                        // Double blue border
                        ctx.strokeStyle = '#1e3a8a';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(20, 20, w - 40, h - 40);
                        ctx.strokeStyle = '#93c5fd';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(36, 36, w - 72, h - 72);
                        // Blue ribbons top and bottom
                        ctx.fillStyle = '#1e3a8a';
                        ctx.fillRect(0, 0, w, h * 0.10);
                        ctx.fillRect(0, h - h * 0.08, w, h * 0.08);
                        // Gold accent lines
                        ctx.fillStyle = '#fbbf24';
                        ctx.fillRect(0, h * 0.10, w, 4);
                        ctx.fillRect(0, h - h * 0.08 - 4, w, 4);
                    }
                },
                {
                    id: 'modren',
                    name: 'Modren',
                    initialHeaderColor: '#0ea5e9',
                    initialBodyColor: '#111827',
                    initialRecipientNameColor: '#22c55e',
                    draw: function(ctx, w, h) {
                        // Bold diagonal split with cyan accents
                        const g = ctx.createLinearGradient(0, 0, w, h);
                        g.addColorStop(0, '#111827');
                        g.addColorStop(1, '#0f172a');
                        ctx.fillStyle = g;
                        ctx.fillRect(0, 0, w, h);
                        // Cyan diagonal shape
                        ctx.fillStyle = '#06b6d4';
                        ctx.beginPath();
                        ctx.moveTo(0, h * 0.25);
                        ctx.lineTo(w * 0.6, 0);
                        ctx.lineTo(w, 0);
                        ctx.lineTo(w, h * 0.2);
                        ctx.lineTo(w * 0.35, h * 0.45);
                        ctx.closePath();
                        ctx.fill();
                        // Accent dots
                        ctx.fillStyle = 'rgba(255,255,255,0.15)';
                        for (let i = 0; i < 50; i++) {
                            const x = Math.random() * w;
                            const y = Math.random() * h;
                            ctx.beginPath();
                            ctx.arc(x, y, 1.2, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                },
                {
                    id: 'office',
                    name: 'Office',
                    initialHeaderColor: '#374151',
                    initialBodyColor: '#F3F4F6',
                    initialRecipientNameColor: '#111827',
                    draw: function(ctx, w, h) {
                        // Clean paper with header and footer bars
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, w, h);
                        ctx.fillStyle = '#374151';
                        ctx.fillRect(0, 0, w, 18);
                        ctx.fillRect(0, h - 18, w, 18);
                        // Subtle grid watermark
                        ctx.strokeStyle = 'rgba(156,163,175,0.15)';
                        ctx.lineWidth = 1;
                        const step = 40;
                        for (let x = 20; x < w; x += step) {
                            ctx.beginPath(); ctx.moveTo(x, 20); ctx.lineTo(x, h - 20); ctx.stroke();
                        }
                        for (let y = 20; y < h; y += step) {
                            ctx.beginPath(); ctx.moveTo(20, y); ctx.lineTo(w - 20, y); ctx.stroke();
                        }
                        // Thin inner border
                        ctx.strokeStyle = '#E5E7EB';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(24, 24, w - 48, h - 48);
                    }
                },
                {
                    id: 'glamor',
                    name: 'Glamor',
                    initialHeaderColor: '#111111',
                    initialBodyColor: '#0b0b0b',
                    initialRecipientNameColor: '#d4af37',
                    draw: function(ctx, w, h) {
                        // Dark luxe background
                        const g = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, Math.max(w,h)/1.2);
                        g.addColorStop(0,'#0b0b0b');
                        g.addColorStop(1,'#000000');
                        ctx.fillStyle = g;
                        ctx.fillRect(0, 0, w, h);
                        // Gold double border
                        ctx.strokeStyle = '#caa75e';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(30, 30, w-60, h-60);
                        ctx.strokeStyle = '#d4af37';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(46, 46, w-92, h-92);
                        // Sparkles
                        ctx.fillStyle = 'rgba(212,175,55,0.6)';
                        for (let i = 0; i < 60; i++) {
                            const x = 60 + Math.random() * (w - 120);
                            const y = 60 + Math.random() * (h - 120);
                            const r = Math.random() * 1.8 + 0.4;
                            ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill();
                        }
                    }
                },
                {
                    id: 'classic-gold',
                    name: 'Classic Gold',
                    initialHeaderColor: '#a16207',
                    initialBodyColor: '#faf7ef',
                    initialRecipientNameColor: '#7c5a27',
                    draw: function(ctx, w, h) {
                        // Parchment-like background
                        const g = ctx.createLinearGradient(0, 0, 0, h);
                        g.addColorStop(0,'#fcfbf7');
                        g.addColorStop(1,'#f3efe3');
                        ctx.fillStyle = g;
                        ctx.fillRect(0, 0, w, h);
                        // Ornate gold borders
                        ctx.strokeStyle = '#c5a66e';
                        ctx.lineWidth = 4;
                        ctx.strokeRect(22, 22, w - 44, h - 44);
                        ctx.strokeStyle = '#a88734';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(40, 40, w - 80, h - 80);
                        // Corner ornament arcs
                        ctx.strokeStyle = '#c5a66e';
                        ctx.lineWidth = 1.5;
                        const r = 24;
                        ctx.beginPath(); ctx.arc(64, 64, r, Math.PI, 1.5*Math.PI); ctx.stroke();
                        ctx.beginPath(); ctx.arc(w-64, 64, r, 1.5*Math.PI, 0); ctx.stroke();
                        ctx.beginPath(); ctx.arc(64, h-64, r, 0.5*Math.PI, Math.PI); ctx.stroke();
                        ctx.beginPath(); ctx.arc(w-64, h-64, r, 0, 0.5*Math.PI); ctx.stroke();
                    }
                },
                {
                    id: 'pastel',
                    name: 'Pastel',
                    initialHeaderColor: '#60a5fa',
                    initialBodyColor: '#f8fafc',
                    initialRecipientNameColor: '#ec4899',
                    draw: function(ctx, w, h) {
                        // Soft gradient background
                        const g = ctx.createLinearGradient(0, 0, w, h);
                        g.addColorStop(0,'#fdf2f8');
                        g.addColorStop(0.5,'#eff6ff');
                        g.addColorStop(1,'#ecfeff');
                        ctx.fillStyle = g;
                        ctx.fillRect(0, 0, w, h);
                        // Rounded panel
                        ctx.fillStyle = 'rgba(255,255,255,0.85)';
                        const m = 28, r = 18;
                        ctx.beginPath();
                        ctx.moveTo(m + r, m);
                        ctx.lineTo(w - m - r, m);
                        ctx.quadraticCurveTo(w - m, m, w - m, m + r);
                        ctx.lineTo(w - m, h - m - r);
                        ctx.quadraticCurveTo(w - m, h - m, w - m - r, h - m);
                        ctx.lineTo(m + r, h - m);
                        ctx.quadraticCurveTo(m, h - m, m, h - m - r);
                        ctx.lineTo(m, m + r);
                        ctx.quadraticCurveTo(m, m, m + r, m);
                        ctx.closePath();
                        ctx.fill();
                        // Border accent
                        ctx.strokeStyle = '#0284c7';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        // Soft shapes
                        ctx.fillStyle = 'rgba(96,165,250,0.15)';
                        ctx.beginPath(); ctx.arc(w-90, 90, 36, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = 'rgba(236,72,153,0.12)';
                        ctx.beginPath(); ctx.arc(110, h-110, 44, 0, Math.PI*2); ctx.fill();
                    }
                },
                {
                    id: 'clean',
                    name: 'Clean',
                    initialHeaderColor: '#2563eb',
                    initialBodyColor: '#ffffff',
                    initialRecipientNameColor: '#111827',
                    draw: function(ctx, w, h) {
                        ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,w,h);
                        ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 2; ctx.strokeRect(24,24,w-48,h-48);
                        ctx.fillStyle = '#2563eb'; ctx.fillRect(0,0,w,10);
                    }
                },
                {
                    id: 'corporate',
                    name: 'Corporate',
                    initialHeaderColor: '#0f172a',
                    initialBodyColor: '#f8fafc',
                    initialRecipientNameColor: '#0f172a',
                    draw: function(ctx, w, h) {
                        const g = ctx.createLinearGradient(0,0,w,0);
                        g.addColorStop(0,'#0f172a'); g.addColorStop(1,'#1f2937');
                        ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,w,h);
                        ctx.fillStyle = g; ctx.fillRect(0,0,w,60);
                        ctx.fillStyle = '#38bdf8'; ctx.fillRect(0,60,w,4);
                    }
                },
                {
                    id: 'nature',
                    name: 'Nature',
                    initialHeaderColor: '#047857',
                    initialBodyColor: '#ecfdf5',
                    initialRecipientNameColor: '#065f46',
                    draw: function(ctx, w, h) {
                        const g = ctx.createLinearGradient(0, 0, 0, h);
                        g.addColorStop(0,'#ecfdf5'); g.addColorStop(1,'#d1fae5');
                        ctx.fillStyle = g; ctx.fillRect(0, 0, w, h);
                        ctx.fillStyle = '#10b981'; ctx.fillRect(0,h-18,w,18);
                        ctx.strokeStyle = '#34d399'; ctx.lineWidth = 3; ctx.strokeRect(28,28,w-56,h-56);
                    }
                },
                {
                    id: 'academic',
                    name: 'Academic',
                    initialHeaderColor: '#1f2937',
                    initialBodyColor: '#f9fafb',
                    initialRecipientNameColor: '#1f2937',
                    draw: function(ctx, w, h) {
                        ctx.fillStyle = '#f9fafb'; ctx.fillRect(0,0,w,h);
                        ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 2; ctx.strokeRect(36,36,w-72,h-72);
                        ctx.fillStyle = '#111827'; ctx.fillRect(0,0,w,14);
                        ctx.fillStyle = '#9ca3af'; ctx.fillRect(0,14,w,4);
                    }
                },
                {
                    id: 'celebration',
                    name: 'Celebration',
                    initialHeaderColor: '#f59e0b',
                    initialBodyColor: '#fff7ed',
                    initialRecipientNameColor: '#b45309',
                    draw: function(ctx, w, h) {
                        ctx.fillStyle = '#fff7ed'; ctx.fillRect(0,0,w,h);
                        ctx.fillStyle = '#fde68a';
                        for (let i=0;i<10;i++){ ctx.beginPath(); ctx.arc(Math.random()*w, Math.random()*h, Math.random()*6+2,0,Math.PI*2); ctx.fill(); }
                        ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 3; ctx.strokeRect(20,20,w-40,h-40);
                    }
                },
                {
                    id: 'vintage',
                    name: 'Vintage',
                    initialHeaderColor: '#92400e',
                    initialBodyColor: '#faf3e0',
                    initialRecipientNameColor: '#7c2d12',
                    draw: function(ctx, w, h) {
                        const g = ctx.createLinearGradient(0,0,0,h);
                        g.addColorStop(0,'#fbf4e4'); g.addColorStop(1,'#f3e7cf');
                        ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
                        ctx.strokeStyle = '#b45309'; ctx.lineWidth = 2; ctx.strokeRect(26,26,w-52,h-52);
                        ctx.setLineDash([6,4]); ctx.strokeRect(42,42,w-84,h-84); ctx.setLineDash([]);
                    }
                },
                {
                    id: 'minimal-cream',
                    name: 'Minimal Cream',
                    initialHeaderColor: '#111827',
                    initialBodyColor: '#fffaf0',
                    initialRecipientNameColor: '#1f2937',
                    draw: function(ctx, w, h) {
                        ctx.fillStyle = '#fffaf0'; ctx.fillRect(0,0,w,h);
                        ctx.strokeStyle = '#fde68a'; ctx.lineWidth = 2; ctx.strokeRect(30,30,w-60,h-60);
                        ctx.fillStyle = '#111827'; ctx.fillRect(0,0,w,8);
                    }
                },
                {
                    id: 'gradient',
                    name: 'Gradient',
                    initialHeaderColor: '#7c3aed',
                    initialBodyColor: '#f5f3ff',
                    initialRecipientNameColor: '#7c3aed',
                    draw: function(ctx, w, h) {
                        const g = ctx.createLinearGradient(0,0,w,h);
                        g.addColorStop(0,'#7c3aed'); g.addColorStop(1,'#06b6d4');
                        ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
                        ctx.fillStyle = 'rgba(255,255,255,0.15)';
                        for (let i=0;i<5;i++){ ctx.fillRect(0, i*(h/5)+2, w, 2); }
                    }
                },
                {
                    id: 'monochrome',
                    name: 'Monochrome',
                    initialHeaderColor: '#111827',
                    initialBodyColor: '#f3f4f6',
                    initialRecipientNameColor: '#111827',
                    draw: function(ctx, w, h) {
                        ctx.fillStyle = '#f3f4f6'; ctx.fillRect(0,0,w,h);
                        ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 2; ctx.strokeRect(24,24,w-48,h-48);
                        ctx.fillStyle = '#111827'; ctx.fillRect(0,h-12,w,12);
                    }
                },
                {
                    id: 'bold-stripe',
                    name: 'Bold Stripe',
                    initialHeaderColor: '#dc2626',
                    initialBodyColor: '#ffffff',
                    initialRecipientNameColor: '#1f2937',
                    draw: function(ctx, w, h) {
                        ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,w,h);
                        ctx.fillStyle = '#dc2626'; ctx.fillRect(0,0,w,22);
                        ctx.fillStyle = '#2563eb'; ctx.fillRect(0,22,w,8);
                        ctx.fillStyle = '#16a34a'; ctx.fillRect(0,30,w,6);
                        ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 2; ctx.strokeRect(20,20,w-40,h-40);
                    }
                },
                {
                    id: 'soft-purple',
                    name: 'Soft Purple',
                    initialHeaderColor: '#7c3aed',
                    initialBodyColor: '#f5f3ff',
                    initialRecipientNameColor: '#6d28d9',
                    draw: function(ctx, w, h) {
                        const g = ctx.createRadialGradient(w*0.3,h*0.3,0,w*0.5,h*0.5,Math.max(w,h));
                        g.addColorStop(0,'#ede9fe'); g.addColorStop(1,'#f5f3ff');
                        ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
                        ctx.strokeStyle = '#ddd6fe'; ctx.lineWidth = 3; ctx.strokeRect(26,26,w-52,h-52);
                    }
                },
                {
                    id: 'newspaper',
                    name: 'Newspaper',
                    initialHeaderColor: '#111827',
                    initialBodyColor: '#f8fafc',
                    initialRecipientNameColor: '#111827',
                    draw: function(ctx, w, h) {
                        ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,w,h);
                        ctx.fillStyle = '#e5e7eb';
                        for (let y=30; y<h-30; y+=18) { ctx.fillRect(36,y,w-72,1); }
                        ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 2; ctx.strokeRect(32,32,w-64,h-64);
                        ctx.fillStyle = '#111827'; ctx.fillRect(0,0,w,14);
                    }
                },
            ];

// Function to draw certificate elements
// The `recipientData` parameter allows drawing for a specific recipient without changing `currentRecipientIndex`
const drawCertificate = (recipientData = null) => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (isCustomImageLoaded && templateImage.complete) {
        const ratio = templateImage.naturalWidth / templateImage.naturalHeight;
        canvas.width = 1123;
        canvas.height = canvas.width / ratio;
        ctx.drawImage(templateImage, 0, 0, canvas.width, canvas.height);
    } else {
        canvas.width = 1123;
        canvas.height = 794;
        drawTemplateBackground(currentTemplateId);
    }
    
    const displayRecipient = recipientData || recipients[currentRecipientIndex] || { name: 'Nama Penerima Contoh', jabatan: 'Jabatan Contoh', nip: 'NIP Contoh', nuptk: 'NUPTK Contoh', serial: `${SERIAL_PREFIX}0001` };

    // Update content of draggable text elements from corresponding textFields inputs
    draggableElements.filter(el => el.type === 'text').forEach(el => {
        if (el.view === 'front') {
            if (el.id === 'recipientName') el.content = displayRecipient.name;
            else if (el.id === 'recipientJabatan') el.content = displayRecipient.jabatan;
            else if (el.id === 'recipientNip') el.content = displayRecipient.nip;
            else if (el.id === 'recipientNuptk') el.content = displayRecipient.nuptk;
            else if (el.id === 'serialNumber') el.content = displayRecipient.serial || `${SERIAL_PREFIX}0001`;
            else if (textFields[el.id]) { // For other text fields, get content from inputs
                el.content = textFields[el.id].value;
            }
        } else if (el.view === 'back') { // NEW: Update content for back elements
            if (backTextFields[el.id]) {
                el.content = backTextFields[el.id].value;
            }
        }
    });

    // Find recipientName element to base dynamic positioning on its Y
    const recipientNameEl = draggableElements.find(el => el.id === 'recipientName');
    // The current Y position for dynamic text flow, starting from recipientName's stored Y
    let dynamicBlockCurrentY = recipientNameEl ? recipientNameEl.y : 0; 

    draggableElements.forEach(el => {
        // Only draw elements for the current view or 'both'
        el.isCurrentlyVisible = (el.view === currentView || el.view === 'both');

        el.calculatedX = el.x;
        el.calculatedY = el.y;
        el.calculatedWidth = el.width || 0;
        el.calculatedHeight = el.height || 0;

        if (el.type === 'text') {
            ctx.font = `${el.fontStyle} ${el.fontSize}px "${el.fontFamily}"`;
            
            let textMetrics = ctx.measureText(el.content);
            let contentWidth = textMetrics.width;
            let contentHeight = el.fontSize * el.lineHeightMultiplier;
            
            // Special handling for multi-line text (description, materi, narasumber)
            if ((el.id === 'description' || el.id === 'backMateri' || el.id === 'backNarasumber') && el.content.trim() !== '') {
                const words = el.content.split(' ');
                let lineCount = 1;
                let currentLine = '';
                for (let n = 0; n < words.length; n++) {
                    const testLine = currentLine + words[n] + ' ';
                    const metricsWrapped = ctx.measureText(testLine);
                    if (metricsWrapped.width > el.maxWidth && n > 0) {
                        lineCount++;
                        currentLine = words[n] + ' ';
                    } else {
                        currentLine = testLine;
                    }
                }
                contentHeight = lineCount * el.fontSize * el.lineHeightMultiplier;
                contentWidth = el.maxWidth; // Use max width for calculated width
            }

            // Dynamic positioning for recipient details (front)
            if (el.view === 'front' && !el.isPositionCustomized && ['recipientJabatan', 'recipientNip', 'recipientNuptk', 'description'].includes(el.id)) {
                const hasContent = el.content.trim() !== '';
                if (hasContent) {
                    let spacing = 0;
                    if (el.id === 'description') spacing = 10;
                    
                    el.calculatedY = dynamicBlockCurrentY + spacing;
                    dynamicBlockCurrentY = el.calculatedY + contentHeight;
                } else {
                    el.calculatedY = dynamicBlockCurrentY;
                    el.isCurrentlyVisible = false;
                }
            } else if (el.view === 'front' && el.isPositionCustomized && ['recipientName', 'recipientJabatan', 'recipientNip', 'recipientNuptk', 'description'].includes(el.id)) {
                el.calculatedY = el.y; 
                if (el.content.trim() !== '') {
                    dynamicBlockCurrentY = el.calculatedY + contentHeight;
                } else {
                    dynamicBlockCurrentY = el.calculatedY;
                    el.isCurrentlyVisible = false;
                }
            } else if (el.id === 'recipientName' && el.view === 'front') {
                el.calculatedY = el.y;
                if (el.content.trim() !== '') {
                    dynamicBlockCurrentY = el.calculatedY + contentHeight;
                }
            }

            el.calculatedWidth = contentWidth;
            el.calculatedHeight = contentHeight;
        }
    });

    // If viewing back, draw v3-style back page and return
    if (currentView === 'back') {
        // Background gradient like v3
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#0ea5e9');
        gradient.addColorStop(1, '#22c55e');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const margin = 40; // smaller margin to give larger inner content area
        const innerRadius = 12;

        // Inner white rounded panel
        ctx.fillStyle = 'rgba(255,255,255,0.96)';
        ctx.beginPath();
        ctx.moveTo(margin + innerRadius, margin);
        ctx.lineTo(canvas.width - margin - innerRadius, margin);
        ctx.quadraticCurveTo(canvas.width - margin, margin, canvas.width - margin, margin + innerRadius);
        ctx.lineTo(canvas.width - margin, canvas.height - margin - innerRadius);
        ctx.quadraticCurveTo(canvas.width - margin, canvas.height - margin, canvas.width - margin - innerRadius, canvas.height - margin);
        ctx.lineTo(margin + innerRadius, canvas.height - margin);
        ctx.quadraticCurveTo(margin, canvas.height - margin, margin, canvas.height - margin - innerRadius);
        ctx.lineTo(margin, margin + innerRadius);
        ctx.quadraticCurveTo(margin, margin, margin + innerRadius, margin);
        ctx.closePath();
        ctx.fill();

        // Border accent
        ctx.strokeStyle = '#0284c7';
        ctx.lineWidth = 3;
        ctx.stroke();

        // Draw logos on back (reuse first two logos)
        const logos = draggableElements.filter(el => el.type === 'image');
        if (logos.length > 0) {
            const marginInnerX = 20;
            const marginInnerY = 20;
            const logoMaxWidth = 120;
            const logoMaxHeight = 80;
            const leftImg = logos[0].image;
            if (leftImg && leftImg.complete) {
                const ratioL = Math.min(logoMaxWidth / leftImg.width, logoMaxHeight / leftImg.height);
                const wL = leftImg.width * ratioL; const hL = leftImg.height * ratioL;
                ctx.drawImage(leftImg, margin + marginInnerX, margin + marginInnerY, wL, hL);
            }
            if (logos.length > 1) {
                const rightImg = logos[1].image;
                if (rightImg && rightImg.complete) {
                    const ratioR = Math.min(logoMaxWidth / rightImg.width, logoMaxHeight / rightImg.height);
                    const wR = rightImg.width * ratioR; const hR = rightImg.height * ratioR;
                    ctx.drawImage(rightImg, canvas.width - margin - marginInnerX - wR, margin + marginInnerY, wR, hR);
                }
            }
        }

        const centerX = canvas.width / 2;
        let currentY = margin + 50;

        // Header
        ctx.fillStyle = '#0f172a';
        ctx.font = '700 34px "Playfair Display"';
        ctx.textAlign = 'center';
        ctx.fillText('Rincian Kegiatan / Materi', centerX, currentY);

        currentY += 34;
        ctx.font = '400 18px "Inter"';
        ctx.fillStyle = '#6b7280';
        ctx.fillText('Berikut adalah daftar narasumber, materi, dan waktu pelaksanaan.', centerX, currentY);

        // Table
        const tableTop = currentY + 40;
        const left = margin + 20;
        const right = canvas.width - margin - 20;
        const colNoWidth = 40;
        const colSpeakerWidth = 200;
        const colTimeWidth = 120;
        const colHoursWidth = 50;
        const colTopicWidth = right - left - colNoWidth - colSpeakerWidth - colTimeWidth - colHoursWidth;

        const headerHeight = 34;
        const rowHeight = 28;

        ctx.textAlign = 'left';
        ctx.font = '600 14px "Inter"';
        ctx.fillStyle = '#0f172a';

        // Header background
        ctx.fillStyle = '#e5f3ff';
        ctx.fillRect(left, tableTop, right - left, headerHeight);
        ctx.fillStyle = '#0f172a';
        let x = left + 8;
        let y = tableTop + headerHeight / 2 + 4;
        ctx.fillText('No', x, y); x += colNoWidth;
        ctx.fillText('Narasumber', x, y); x += colSpeakerWidth;
        ctx.fillText('Materi', x, y); x += colTopicWidth;
        ctx.fillText('Waktu', x, y); x += colTimeWidth;
        ctx.textAlign = 'center';
        ctx.fillText('JP', x + colHoursWidth / 2 - 8, y);

        // Separator line
        ctx.strokeStyle = '#cbd5f5';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(left, tableTop + headerHeight);
        ctx.lineTo(right, tableTop + headerHeight);
        ctx.stroke();

        // Rows
        ctx.font = '400 14px "Inter"';
        let rowY = tableTop + headerHeight + rowHeight;
        if (!backSessions || backSessions.length === 0) {
            ctx.textAlign = 'center';
            ctx.fillStyle = '#9ca3af';
            ctx.fillText('Belum ada sesi ditambahkan.', centerX, rowY);
        } else {
            backSessions.forEach((s, idx) => {
                if (rowY > canvas.height - margin - 40) return;
                ctx.textAlign = 'left';
                ctx.fillStyle = '#0f172a';
                let cx = left + 8; const cy = rowY - rowHeight / 2 + 10;
                ctx.fillText(String(idx + 1), cx, cy); cx += colNoWidth;
                ctx.fillText(s.speaker || '', cx, cy); cx += colSpeakerWidth;
                // Trim topic to fit
                const topicMax = colTopicWidth - 12; let topicTxt = s.topic || '';
                while (ctx.measureText(topicTxt).width > topicMax && topicTxt.length > 0) topicTxt = topicTxt.slice(0, -1);
                ctx.fillText(topicTxt, cx, cy); cx += colTopicWidth;
                ctx.fillText(s.time || '', cx, cy); cx += colTimeWidth;
                ctx.textAlign = 'center';
                ctx.fillText(String(s.hours || ''), cx + colHoursWidth / 2 - 8, cy);
                rowY += rowHeight;
            });
            // Draw Total JP
            const totalJp = backSessions.reduce((sum, s) => sum + (Number(s.hours) || 0), 0);
            ctx.textAlign = 'right';
            ctx.font = '600 14px "Inter"';
            ctx.fillStyle = '#0f172a';
            ctx.fillText(`Total JP: ${totalJp}`, right, rowY + 10);
        }
        return; // Back view done
    }

    // Draw all visible elements
    draggableElements.forEach(el => {
        if (!el.isCurrentlyVisible) return;

        if (el.type === 'text') {
            ctx.font = `${el.fontStyle} ${el.fontSize}px "${el.fontFamily}"`;
            ctx.fillStyle = el.color;
            ctx.textAlign = el.textAlign;
            ctx.textBaseline = el.textBaseline;

            const drawX = el.calculatedX;
            const drawY = el.calculatedY;

            // Draw multi-line text for description, backMateri, backNarasumber
            if ((el.id === 'description' || el.id === 'backMateri' || el.id === 'backNarasumber') && el.content.trim() !== '') {
                const words = el.content.split(' ');
                let line = '';
                let yOffset = 0;
                for (let n = 0; n < words.length; n++) {
                    const testLine = line + words[n] + ' ';
                    const metricsWrapped = ctx.measureText(testLine);
                    if (metricsWrapped.width > el.maxWidth && n > 0) {
                        ctx.fillText(line, drawX, drawY + yOffset);
                        line = words[n] + ' ';
                        yOffset += el.fontSize * el.lineHeightMultiplier;
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line, drawX, drawY + yOffset);
            } else {
                ctx.fillText(el.content, drawX, drawY);
            }

            // Draw underline for issuer, issuer2, and recipientName
            if ((el.id === 'issuer' || el.id === 'issuer2' || el.id === 'recipientName') && el.content.trim() !== '') {
                const textWidth = ctx.measureText(el.content).width;
                const lineY = drawY + (el.textBaseline === 'alphabetic' ? (el.fontSize * 0.1) : 0);
                ctx.beginPath();
                ctx.moveTo(drawX - textWidth / 2, lineY);
                ctx.lineTo(drawX + textWidth / 2, lineY);
                ctx.lineWidth = 1;
                ctx.strokeStyle = el.color;
                ctx.stroke();
            }

            // Draw selection border (alignment-aware)
            if (selectedDraggableElement && selectedDraggableElement.id === el.id && !isDownloading) {
                let selLeft = el.calculatedX;
                if (el.textAlign === 'center') selLeft = el.calculatedX - el.calculatedWidth / 2;
                else if (el.textAlign === 'right') selLeft = el.calculatedX - el.calculatedWidth;

                let selTop = el.calculatedY;
                if (el.textBaseline === 'alphabetic') selTop = el.calculatedY - el.fontSize;
                else if (el.textBaseline === 'middle') selTop = el.calculatedY - el.calculatedHeight / 2;

                ctx.strokeStyle = '#1d4ed8';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(selLeft - 5, selTop - 5, el.calculatedWidth + 10, el.calculatedHeight + 10);
                ctx.setLineDash([]);
            }
        } else if (el.type === 'image' && el.image && el.image.complete) {
            ctx.drawImage(el.image, el.x, el.y, el.width, el.height);
            
            // Draw selection border for images
            if (selectedDraggableElement && selectedDraggableElement.id === el.id && !isDownloading) {
                ctx.strokeStyle = '#1d4ed8';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(el.x - 5, el.y - 5, el.width + 10, el.height + 10);
                ctx.setLineDash([]);
            }
        }
    });
};

const initializeDefaultState = () => {
    if (textFields.title) textFields.title.value = "Sertifikat Penghargaan";
    if (textFields.subtitle) textFields.subtitle.value = "DIBERIKAN KEPADA";
    if (textFields.description) textFields.description.value = "Atas partisipasi dan kontribusi luar biasa dalam Workshop Pengembangan Aplikasi Web Interaktif.";
    if (textFields.headerCertificateText) textFields.headerCertificateText.value = "SERTIFIKAT";
    if (textFields.issuer) textFields.issuer.value = "Sugandi,S.Kom";
    if (textFields.issuerTitle) textFields.issuerTitle.value = "Direktur Program";
    if (textFields.issuerNip) textFields.issuerNip.value = "1994xxxxxxxxxx1001";
    if (textFields.issuer2) textFields.issuer2.value = "Prof. Siti Aminah";
    if (textFields.issuerTitle2) textFields.issuerTitle2.value = "Kepala Departemen";
    if (textFields.issuerNip2) textFields.issuerNip2.value = "198005152005022002";
    if (textFields.date) textFields.date.value = "27 Juni 2025";

    // NEW: Default values for back text fields
    if (backTextFields.backMateri) backTextFields.backMateri.value = "- Pengenalan HTML & CSS (09:00 - 10:30)\n- JavaScript Dasar (10:45 - 12:00)\n- Studi Kasus Proyek (13:00 - 14:30)";
    if (backTextFields.backNarasumber) backTextFields.backNarasumber.value = "- Budi Santoso, S.T., M.Kom\n- Dr. Indah Permata, M.Eng";
    if (backTextFields.backJam) backTextFields.backJam.value = "09:00 - 16:00 WIB";

    // Added null checks for recipient input fields
    if (recipientNameInput) recipientNameInput.value = '';
    if (recipientJabatanInput) recipientJabatanInput.value = '';
    if (recipientNipInput) recipientNipInput.value = '';
    if (recipientNuptkInput) recipientNuptkInput.value = '';
    if (editingIndexInput) editingIndexInput.value = '';

    recipients = [];
    nextSerialNumber = 1;
    currentRecipientIndex = -1;
    currentTemplateId = 'professional';
    isCustomImageLoaded = false;
    templateImage.src = '';
    nextLogoId = 0;
    currentView = 'front'; // NEW: Reset view to front

    draggableElements = defaultDraggableTextElements.map(el => ({
        ...el,
        isColorCustomized: false,
        isFontFamilyCustomized: false,
        isFontSizeCustomized: false,
        isAlignCustomized: false,
        isPositionCustomized: false,
        calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true
    }));
    
    draggableElements.filter(el => el.type === 'text').forEach(el => {
        if (el.view === 'front') {
            if (el.id === 'recipientName') {
                el.content = 'Nama Penerima Contoh';
            } else if (el.id === 'recipientJabatan') { // Added back recipient fields
                el.content = 'Jabatan Contoh';
            } else if (el.id === 'recipientNip') {
                el.content = 'NIP Contoh';
            } else if (el.id === 'recipientNuptk') {
                el.content = 'NUPTK Contoh';
            } else if (el.id === 'serialNumber') {
                el.content = `${SERIAL_PREFIX}0001`;
            } else if (textFields[el.id]) {
                el.content = textFields[el.id].value;
            }
            
            if (el.id === 'title') {
                el.x = canvas.width / 2;
                el.y = 100;
                el.textAlign = 'center';
                el.fontFamily = 'Playfair Display';
                el.fontSize = 70;
                el.fontStyle = 'bold';
            } else if (el.id === 'headerCertificateText') {
                el.x = canvas.width / 2;
                el.y = 220;
                el.textAlign = 'center';
                el.fontFamily = 'Inter';
                el.fontSize = 50;
                el.fontStyle = 'bold';
            }
        } else if (el.view === 'back') { // NEW: Set content for back elements
            if (backTextFields[el.id]) {
                el.content = backTextFields[el.id].value;
            }
        }
    });
    
    allTemplates = [...hardcodedTemplates]; // Reset allTemplates to only hardcoded ones

    selectProvidedTemplate(currentTemplateId);
    renderRecipientTable();
    renderLogoThumbnails();
    renderBackSessionsTable();
    renderTemplateThumbnails(); 
    updateUI();
    updateBackAddButtonState();
    updateSidebarControls();
    localStorage.removeItem(LOCAL_STORAGE_KEY);
    saveState();
};

const resetAllData = async () => {
    const confirmReset = await showModal('Anda yakin ingin mereset semua data? Ini akan menghapus semua penerima, logo, dan pengaturan sertifikat.', true);
    if (!confirmReset) return;
    localStorage.removeItem(LOCAL_STORAGE_KEY);
    initializeDefaultState();
};

// Clear only text inputs without resetting recipients/logos
const clearAllTextFields = async () => {
    const confirmClear = await showModal('Anda yakin ingin mengosongkan semua bidang input teks?', true);
    if (!confirmClear) return;
    for (const key in textFields) {
        if (Object.prototype.hasOwnProperty.call(textFields, key) && textFields[key]) {
            textFields[key].value = '';
            const draggableElement = draggableElements.find(el => el.id === key);
            if (draggableElement) draggableElement.content = '';
        }
    }
    drawCertificate();
    saveState();
};

            if (dataTabs.manual) {
                dataTabs.manual.addEventListener('click', () => switchTab(dataTabs, 'manual', dataContents));
            }

            if (dataTabs.excel) {
                dataTabs.excel.addEventListener('click', () => switchTab(dataTabs, 'excel', dataContents));
            }

            // Template thumbnail click listeners are now attached dynamically in renderTemplateThumbnails

            // Add event listeners for template tabs (Provided vs Upload)
            if (templateTabs.provided) {
                templateTabs.provided.addEventListener('click', () => switchTab(templateTabs, 'provided', templateContents));
            }
            if (templateTabs.upload) {
                templateTabs.upload.addEventListener('click', () => {
                    switchTab(templateTabs, 'upload', templateContents);
                    if (templateUploadInput) {
                        // Ensure it's visible, then focus and open picker
                        try { templateUploadInput.focus(); } catch (_) {}
                        // Some browsers block programmatic click unless triggered by user gesture
                        templateUploadInput.click();
                    }
                });
            }

            if (templateUploadInput) { // Added null check
                templateUploadInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => selectCustomTemplateImage(event.target.result);
                        reader.onerror = async () => await showModal('Gagal membaca file lokal.');
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Event listeners for front text fields
            Object.keys(textFields).forEach(fieldId => {
                // The recipientName, Jabatan, Nip, Nuptk are handled by the recipient input fields, not these general text fields.
                if (!['recipientName', 'recipientJabatan', 'recipientNip', 'recipientNuptk'].includes(fieldId)) {
                    if (textFields[fieldId]) { // Ensure the text field element actually exists
                        textFields[fieldId].addEventListener('input', (event) => {
                            const draggableElement = draggableElements.find(el => el.id === fieldId);
                            if (draggableElement) {
                                draggableElement.content = event.target.value;
                                drawCertificate();
                                saveState();
                            }
                        });
                    }
                }
            });

            // NEW: Event listeners for back text fields
            Object.keys(backTextFields).forEach(fieldId => {
                if (backTextFields[fieldId]) { // Ensure the back text field element actually exists
                    backTextFields[fieldId].addEventListener('input', (event) => {
                        const draggableElement = draggableElements.find(el => el.id === fieldId);
                        if (draggableElement) {
                            draggableElement.content = event.target.value;
                            drawCertificate();
                            saveState();
                        }
                    });
                }
            });


            if (fontSizeInput) { // Added null check
                fontSizeInput.addEventListener('input', (e) => {
                    if (selectedDraggableElement && selectedDraggableElement.type === 'text') {
                        selectedDraggableElement.fontSize = parseInt(e.target.value);
                        selectedDraggableElement.isFontSizeCustomized = true;
                        drawCertificate();
                        saveState();
                    }
                });
            }

            if (fontWeightBold) { // Added null check
                fontWeightBold.addEventListener('change', (e) => {
                    if (selectedDraggableElement && selectedDraggableElement.type === 'text') {
                        selectedDraggableElement.fontStyle = e.target.checked ? 'bold' : 'normal';
                        selectedDraggableElement.isFontFamilyCustomized = true;
                        drawCertificate();
                        saveState();
                    }
                });
            }

            if (fontFamilySelect) { // Added null check
                fontFamilySelect.addEventListener('change', (e) => {
                    if (selectedDraggableElement && selectedDraggableElement.type === 'text') {
                        selectedDraggableElement.fontFamily = e.target.value;
                        selectedDraggableElement.isFontFamilyCustomized = true;

                        requestAnimationFrame(() => {
                            drawCertificate();
                            saveState();
                        });
                    }
                });
            }

            if (textColorInput) { // Added null check
                textColorInput.addEventListener('input', (e) => {
                    if (selectedDraggableElement && selectedDraggableElement.type === 'text') {
                        selectedDraggableElement.color = e.target.value;
                        selectedDraggableElement.isColorCustomized = true;
                        drawCertificate();
                        saveState();
                    }
                });
            }

            if (textAlignSelect) { // Added null check
                textAlignSelect.addEventListener('change', (e) => {
                    if (selectedDraggableElement && selectedDraggableElement.type === 'text') {
                        selectedDraggableElement.textAlign = e.target.value;
                        selectedDraggableElement.isAlignCustomized = true;
                        drawCertificate();
                        saveState();
                    }
                });
            }

            if (fontUploadInput) { // Added null check
                fontUploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const fileNameWithoutExt = file.name.split('.').slice(0, -1).join('.');
                        const fontName = `CustomFont_${fileNameWithoutExt.replace(/[^a-zA-Z0-9]/g, '')}`;
                        
                        showLoading(true);
                        try {
                            if (Array.from(fontFamilySelect.options).some(option => option.value === fontName)) {
                                await showModal(`Font '${fontName}' sudah dimuat.`);
                                showLoading(false);
                                return;
                            }

                            const font = new FontFace(fontName, `url(${URL.createObjectURL(file)})`);
                            await font.load();
                            document.fonts.add(font);

                            const option = document.createElement('option');
                            option.value = fontName;
                            option.textContent = `${fileNameWithoutExt} (Custom)`;
                            fontFamilySelect.appendChild(option);

                            fontFamilySelect.value = fontName;
                            if (selectedDraggableElement && selectedDraggableElement.type === 'text') {
                                selectedDraggableElement.fontFamily = fontName;
                                selectedDraggableElement.isFontFamilyCustomized = true;
                                requestAnimationFrame(() => {
                                    drawCertificate();
                                    saveState();
                                });
                            } else {
                                drawCertificate();
                                saveState();
                            }
                            await showModal(`Font '${fileNameWithoutExt}' berhasil dimuat dan tersedia di daftar pilihan!`);
                        } catch (error) {
                            console.error('Error loading custom font:', error);
                            await showModal(`Gagal memuat font: ${error.message}. Pastikan file font valid.`);
                        } finally {
                            showLoading(false);
                            fontUploadInput.value = '';
                        }
                    }
                });
            }

            if (imageWidthInput) { // Added null check
                imageWidthInput.addEventListener('input', (e) => {
                    if (selectedDraggableElement && selectedDraggableElement.type === 'image') {
                        selectedDraggableElement.width = parseInt(e.target.value);
                        drawCertificate();
                        saveState();
                    }
                });
            }

            if (imageHeightInput) { // Added null check
                imageHeightInput.addEventListener('input', (e) => {
                    if (selectedDraggableElement && selectedDraggableElement.type === 'image') {
                        selectedDraggableElement.height = parseInt(e.target.value);
                        drawCertificate();
                        saveState();
                    }
                });
            }

            if (addRecipientBtn) { // Added null check
                addRecipientBtn.addEventListener('click', async () => {
                    const name = recipientNameInput.value.trim();
                    const jabatan = recipientJabatanInput.value.trim();
                    const nip = recipientNipInput.value.trim();
                    const nuptk = recipientNuptkInput.value.trim();
                    const editingIndex = parseInt(editingIndexInput.value, 10);

                    if (!name) {
                        await showModal('Nama penerima tidak boleh kosong.');
                        return;
                    }

                    let serial;
                    if (!isNaN(editingIndex) && editingIndex >= 0 && editingIndex < recipients.length) {
                        serial = recipients[editingIndex].serial || generateSerial();
                    } else {
                        serial = generateSerial();
                    }

                    const newRecipientData = { name, jabatan, nip, nuptk, serial };

                    if (!isNaN(editingIndex) && editingIndex >= 0 && editingIndex < recipients.length) {
                        recipients[editingIndex] = newRecipientData;
                        addRecipientBtn.innerHTML = '<i class="fas fa-save"></i> Perbarui Penerima';
                        addRecipientBtn.classList.replace('bg-green-600', 'bg-yellow-500');
                        addRecipientBtn.classList.replace('hover:bg-green-700', 'hover:bg-yellow-600');
                    } else {
                        recipients.push(newRecipientData);
                    }
                    
                    if (recipientNameInput) recipientNameInput.value = ''; // Added null check
                    if (recipientJabatanInput) recipientJabatanInput.value = ''; // Added null check
                    if (recipientNipInput) recipientNipInput.value = ''; // Added null check
                    if (recipientNuptkInput) recipientNuptkInput.value = ''; // Added null check
                    if (editingIndexInput) editingIndexInput.value = ''; // Added null check
                    if (recipientNameInput) recipientNameInput.focus(); // Added null check

                    if (recipients.length === 1) currentRecipientIndex = 0;
                    renderRecipientTable();
                    drawCertificate();
                    saveState();
                });
            }

            if (importExcelBtn) { // Added null check
                importExcelBtn.addEventListener('click', async () => {
                    const file = excelUploadInput.files[0];
                    if (!file) {
                        await showModal('Silakan pilih file Excel terlebih dahulu.');
                        return;
                    }
                    showLoading(true);
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            let newRecipients = json
                                .map(row => ({
                                    name: row[0] ? String(row[0]).trim() : '',
                                    jabatan: row[1] ? String(row[1]).trim() : '',
                                    nip: row[2] ? String(row[2]).trim() : '',
                                    nuptk: row[3] ? String(row[3]).trim() : '',
                                }))
                                .filter(recipient => recipient.name !== '');

                            newRecipients = newRecipients.map(rec => ({
                                ...rec,
                                serial: generateSerial(),
                            }));
                            
                            if (newRecipients.length === 0) {
                                await showModal('Tidak ada nama yang valid ditemukan di kolom pertama file Excel. Pastikan kolom A berisi nama.');
                                showLoading(false);
                                return;
                            }
                            
                            recipients = newRecipients;
                            currentRecipientIndex = recipients.length > 0 ? 0 : -1;
                            renderRecipientTable();
                            drawCertificate();
                            await showModal(`${newRecipients.length} nama berhasil diimpor dari Excel.`);
                            saveState();
                        } catch (error) {
                            console.error('Error importing Excel:', error);
                            await showModal(`Gagal mengimpor file Excel: ${error.message}. Pastikan ini adalah file Excel yang valid dan formatnya benar.`);
                        } finally {
                            showLoading(false);
                        }
                    };
                    reader.onerror = async (error) => {
                        console.error('FileReader error:', error);
                        await showModal('Gagal membaca file: Terjadi kesalahan.');
                        showLoading(false);
                    };
                    reader.readAsArrayBuffer(file);
                });
            }

            if (downloadExcelTemplateBtn) {
                downloadExcelTemplateBtn.addEventListener('click', () => {
                    try {
                        const header = [['Nama', 'Jabatan', 'NIP', 'NUPTK']];
                        const example = [['Andi Wijaya', 'Manajer Proyek', '198510202010011005', '1234567890123456']];
                        const aoa = header.concat(example);
                        const ws = XLSX.utils.aoa_to_sheet(aoa);
                        ws['!cols'] = [{ wch: 30 }, { wch: 24 }, { wch: 22 }, { wch: 20 }];
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'Template');
                        XLSX.writeFile(wb, 'template_import_penerima.xlsx');
                    } catch (e) {
                        showModal('Gagal membuat template Excel.');
                    }
                });
            }

            const handleEdit = (event) => {
                const index = parseInt(event.currentTarget.dataset.index, 10);
                if (index >= 0 && index < recipients.length) {
                    const recipientToEdit = recipients[index];
                    if (recipientNameInput) recipientNameInput.value = recipientToEdit.name;
                    if (recipientJabatanInput) recipientJabatanInput.value = recipientToEdit.jabatan || '';
                    if (recipientNipInput) recipientNipInput.value = recipientToEdit.nip || '';
                    if (recipientNuptkInput) recipientNuptkInput.value = recipientToEdit.nuptk || '';
                    if (editingIndexInput) editingIndexInput.value = index;
                    if (addRecipientBtn) {
                        addRecipientBtn.innerHTML = '<i class="fas fa-save"></i> Perbarui Penerima';
                        addRecipientBtn.classList.replace('bg-green-600', 'bg-yellow-500');
                        addRecipientBtn.classList.replace('hover:bg-green-700', 'hover:bg-yellow-600');
                    }
                }
            };

            const handleDelete = async (event) => {
                const index = parseInt(event.currentTarget.dataset.index, 10);
                if (index >= 0 && index < recipients.length) {
                    const confirmDelete = await showModal(`Anda yakin ingin menghapus '${recipients[index].name}'?`, true);
                    if (confirmDelete) {
                        recipients.splice(index, 1);
                        if (currentRecipientIndex >= recipients.length) {
                            currentRecipientIndex = recipients.length - 1;
                        }
                        if (currentRecipientIndex < 0 && recipients.length > 0) {
                             currentRecipientIndex = 0;
                        } else if (recipients.length === 0) {
                             currentRecipientIndex = -1;
                        }

                        renderRecipientTable();
                        drawCertificate();
                        if (editingIndexInput && parseInt(editingIndexInput.value, 10) === index) {
                            if (recipientNameInput) recipientNameInput.value = '';
                            if (recipientJabatanInput) recipientJabatanInput.value = '';
                            if (recipientNipInput) recipientNipInput.value = '';
                            if (recipientNuptkInput) recipientNuptkInput.value = '';
                            editingIndexInput.value = '';
                            if (addRecipientBtn) {
                                addRecipientBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Tambah ke Daftar';
                                addRecipientBtn.classList.replace('bg-yellow-500', 'bg-green-600');
                                addRecipientBtn.classList.replace('hover:bg-yellow-700', 'hover:bg-green-700');
                            }
                        }
                        saveState();
                    }
                }
            };

            const addLogoToCanvas = (src) => {
                showLoading(true);
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    const newLogo = {
                        id: `logo-${nextLogoId++}`,
                        type: 'image',
                        image: img,
                        x: 50 + (draggableElements.filter(el => el.type === 'image').length * 110),
                        y: 50,
                        width: 100,
                        height: 100,
                        src: src,
                        isPositionCustomized: false,
                        view: 'both', // Logos visible on both sides
                        calculatedX: 0, calculatedY: 0, calculatedWidth: 0, calculatedHeight: 0, isCurrentlyVisible: true 
                    };
                    draggableElements.push(newLogo);
                    renderLogoThumbnails();
                    drawCertificate();
                    showLoading(false);
                    showModal('Logo berhasil ditambahkan! Anda bisa menggesernya di pratinjau.');
                    saveState();
                };
                img.onerror = async () => {
                    showLoading(false);
                    await showModal('Gagal memuat logo. Pastikan URL benar atau file tidak rusak, dan gambar dapat diakses (CORS diizinkan jika dari URL eksternal).');
                };
                img.src = src;
            };

            if (logoUploadInput) { // Added null check
                logoUploadInput.addEventListener('change', (e) => {
                    const files = e.target.files;
                    if (files.length > 0) {
                        Array.from(files).forEach(file => {
                            const reader = new FileReader();
                            reader.onload = (event) => addLogoToCanvas(event.target.result);
                            reader.onerror = async () => await showModal(`Gagal membaca file: ${file.name}.`);
                            reader.readAsDataURL(file);
                        });
                        logoUploadInput.value = '';
                    }
                });
            }

            if (addLogoUrlBtn) { // Added null check
                addLogoUrlBtn.addEventListener('click', () => {
                    const url = logoUrlInput.value.trim();
                    if (url) {
                        addLogoToCanvas(url);
                        if (logoUrlInput) logoUrlInput.value = ''; // Added null check
                    } else {
                        showModal('Silakan masukkan URL gambar logo.');
                    }
                });
            }

            const handleDeleteLogo = async (event) => {
                const logoId = event.currentTarget.dataset.id;
                const confirmDelete = await showModal(`Anda yakin ingin menghapus logo ini?`, true);
                if (confirmDelete) {
                    draggableElements = draggableElements.filter(el => el.id !== logoId);
                    renderLogoThumbnails();
                    drawCertificate();
                    if (selectedDraggableElement && selectedDraggableElement.id === logoId) {
                        selectedDraggableElement = null;
                        updateSidebarControls();
                    }
                    saveState();
                }
            };


            if (prevBtn) { // Added null check
                prevBtn.addEventListener('click', () => {
                    if (currentRecipientIndex > 0) {
                        currentRecipientIndex--;
                        drawCertificate();
                        updateRecipientIndicator();
                        saveState();
                    }
                });
            }

            if (nextBtn) { // Added null check
                nextBtn.addEventListener('click', () => {
                    if (currentRecipientIndex < recipients.length - 1) {
                        currentRecipientIndex++;
                        drawCertificate();
                        updateRecipientIndicator();
                        saveState();
                    }
                });
            }

            // NEW: View switch buttons
            if (viewFrontBtn) { // Added null check
                viewFrontBtn.addEventListener('click', () => {
                    currentView = 'front';
                    drawCertificate();
                    updateUI();
                    saveState();
                });
            }

            if (viewBackBtn) { // Added null check
                viewBackBtn.addEventListener('click', () => {
                    currentView = 'back';
                    drawCertificate();
                    updateUI();
                    saveState();
                });
            }


            if (downloadPngBtn) { // Added null check
                downloadPngBtn.addEventListener('click', () => {
                    if (recipients.length === 0) {
                        showModal('Tambahkan setidaknya satu penerima untuk mengunduh sertifikat.');
                        return;
                    }
                    showLoading(true);
                    isDownloading = true;
                    drawCertificate(); // Ensure current recipient is drawn before capture

                    html2canvas(canvas, { scale: 4, useCORS: true }).then(function(canvasImg) {
                        const link = document.createElement('a');
                        link.download = `sertifikat-${recipients[currentRecipientIndex].name.replace(/\s+/g, '-')}-${currentView}.png`;
                        link.href = canvasImg.toDataURL('image/png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        isDownloading = false;
                        drawCertificate(); // Redraw to show selection border if any
                        showLoading(false);
                    }).catch(error => {
                        console.error('Error during canvas capture (PNG):', error);
                        showModal(`Gagal mengunduh sertifikat PNG: ${error.message}.`);
                        
                        isDownloading = false;
                        drawCertificate();
                        showLoading(false);
                    });
                });
            }

            if (downloadPdfBtn) { // Added null check
                downloadPdfBtn.addEventListener('click', () => {
                    if (recipients.length === 0) {
                        showModal('Tambahkan setidaknya satu penerima untuk mengunduh sertifikat.');
                        return;
                    }
                    showLoading(true);
                    isDownloading = true;
                    drawCertificate(); // Ensure current recipient is drawn before capture

                    html2canvas(canvas, { scale: 4, useCORS: true }).then(function(canvasImg) {
                        const imgData = canvasImg.toDataURL('image/png');
                        const { jsPDF } = window.jspdf;

                        const imgWidth = 297; // A4 width in mm
                        const imgHeight = (canvasImg.height * imgWidth) / canvasImg.width; // Calculate height to maintain aspect ratio

                        let pdf;
                        if (canvasImg.width > canvasImg.height) { // Landscape
                            pdf = new jsPDF('landscape', 'mm', 'a4');
                        } else { // Portrait
                            pdf = new jsPDF('portrait', 'mm', 'a4');
                        }

                        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                        pdf.save(`sertifikat-${recipients[currentRecipientIndex].name.replace(/\s+/g, '-')}-${currentView}.pdf`);
                        
                        isDownloading = false;
                        drawCertificate(); // Redraw to show selection border if any
                        showLoading(false);
                    }).catch(error => {
                        console.error('Error during canvas capture (PDF):', error);
                        showModal(`Gagal mengunduh sertifikat PDF: ${error.message}.`);
                        
                        isDownloading = false;
                        drawCertificate();
                        showLoading(false);
                    });
                });
            }
            
            // NEW: Download All Recipients as a Single PDF
            if (downloadAllPdfBtn) { // Added null check
                downloadAllPdfBtn.addEventListener('click', async () => {
                    if (recipients.length === 0) {
                        await showModal('Tambahkan setidaknya satu penerima untuk mengunduh sertifikat.');
                        return;
                    }

                    showLoading(true);
                    isDownloading = true;
                    
                    const { jsPDF } = window.jspdf;
                    let pdf = null;
                    
                    const originalRecipientIndex = currentRecipientIndex; // Store original index to restore later
                    const originalView = currentView; // Store original view to restore later

                    try {
                        for (let i = 0; i < recipients.length; i++) {
                            const recipient = recipients[i];
                            
                            // --- Draw and add Front of Certificate ---
                            currentView = 'front'; // Temporarily switch to front view
                            drawCertificate(recipient); // Draw front for the current recipient
                            
                            const canvasImgFront = await html2canvas(canvas, { scale: 4, useCORS: true });
                            const imgDataFront = canvasImgFront.toDataURL('image/png');
                            
                            const imgWidth = 297; // A4 width in mm
                            const imgHeight = (canvasImgFront.height * imgWidth) / canvasImgFront.width;

                            if (!pdf) {
                                pdf = new jsPDF(canvasImgFront.width > canvasImgFront.height ? 'landscape' : 'portrait', 'mm', 'a4');
                            } else {
                                pdf.addPage();
                            }
                            pdf.addImage(imgDataFront, 'PNG', 0, 0, imgWidth, imgHeight);

                            // --- Draw and add Back of Certificate ---
                            currentView = 'back'; // Temporarily switch to back view
                            drawCertificate(recipient); // Draw back for the current recipient (recipient data won't change back content)
                            
                            const canvasImgBack = await html2canvas(canvas, { scale: 4, useCORS: true });
                            const imgDataBack = canvasImgBack.toDataURL('image/png');

                            pdf.addPage(); // Add a new page for the back
                            pdf.addImage(imgDataBack, 'PNG', 0, 0, imgWidth, imgHeight);
                        }
                        
                        pdf.save(`semua-sertifikat-${new Date().toISOString().slice(0,10)}.pdf`);
                        await showModal('Semua sertifikat berhasil diunduh sebagai satu PDF!');

                    } catch (error) {
                        console.error('Error during bulk PDF download:', error);
                        await showModal(`Gagal mengunduh semua sertifikat PDF: ${error.message}.`);
                    } finally {
                        isDownloading = false;
                        currentRecipientIndex = originalRecipientIndex; // Restore original recipient
                        currentView = originalView; // Restore original view
                        drawCertificate(); // Redraw the certificate for the original recipient and view
                        showLoading(false);
                    }
                });
            }


            if (resetAllDataBtn) resetAllDataBtn.addEventListener('click', resetAllData); // Added null check
            if (clearTextFieldsBtn) clearTextFieldsBtn.addEventListener('click', clearAllTextFields); // Added null check

            // === DRAGGING LOGIC ===
            if (canvas) { // Added null check
                canvas.addEventListener('mousedown', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;

                    const mouseX = (e.clientX - rect.left) * scaleX;
                    const mouseY = (e.clientY - rect.top) * scaleY;

                    selectedDraggableElement = null;

                    drawCertificate();

                    // Iterate in reverse to select elements on top first
                    for (let i = draggableElements.length - 1; i >= 0; i--) {
                        const el = draggableElements[i];

                        // Skip if not currently visible
                        if (!el.isCurrentlyVisible) {
                            continue;
                        }

                        let left, top, elementWidth, elementHeight;

                        // For images, their calculatedX/Y/Width/Height are the same as x/y/width/height (no content-based layout)
                        if (el.type === 'image') {
                            left = el.x;
                            top = el.y;
                            elementWidth = el.width;
                            elementHeight = el.height;
                        } else { // type === 'text'
                            elementWidth = el.calculatedWidth;
                            elementHeight = el.calculatedHeight;
                            if (el.textAlign === 'center') left = el.calculatedX - elementWidth / 2;
                            else if (el.textAlign === 'right') left = el.calculatedX - elementWidth;
                            else left = el.calculatedX; // left

                            if (el.textBaseline === 'alphabetic') top = el.calculatedY - el.fontSize;
                            else if (el.textBaseline === 'middle') top = el.calculatedY - elementHeight / 2;
                            else top = el.calculatedY; // top
                        }

                        if (mouseX >= left && mouseX <= (left + elementWidth) &&
                            mouseY >= top && mouseY <= (top + elementHeight)) {
                            
                            draggedElement = el;
                            selectedDraggableElement = el;
                            // Ensure the UI reflects the selected element's side (front/back)
                            if (el.view && el.view !== currentView) {
                                currentView = el.view;
                            }
                            dragStartX = mouseX;
                            dragStartY = mouseY;
                            elementStartX = el.x;
                            elementStartY = el.y;
                            canvas.style.cursor = 'grabbing';
                            updateUI();
                            if (elementControlsSection && currentView === 'front') {
                                try { elementControlsSection.classList.remove('hidden'); } catch (_) {}
                            }
                            drawCertificate();

                            break;
                        }
                    }
                    if (!draggedElement && selectedDraggableElement) {
                        selectedDraggableElement = null;
                        updateSidebarControls();
                        drawCertificate();
                    }
                });
            }

            if (canvas) { // Added null check
                canvas.addEventListener('mousemove', (e) => {
                    if (!draggedElement) return;

                    const rect = canvas.getBoundingClientRect();
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;

                    const mouseX = (e.clientX - rect.left) * scaleX;
                    const mouseY = (e.clientY - rect.top) * scaleY;

                    const dx = mouseX - dragStartX;
                    const dy = mouseY - dragStartY;

                    let newX = elementStartX + dx;
                    let newY = elementStartY + dy;

                    // Mark elements as position customized if they are moved from their default dynamic positions
                    if (['recipientJabatan', 'recipientNip', 'recipientNuptk', 'description', 'date', 'dateLabel'].includes(draggedElement.id) ||
                        ['backMateri', 'backNarasumber', 'backJam'].includes(draggedElement.id)) {
                        draggedElement.isPositionCustomized = true;
                    }

                    // Clamp newX and newY to canvas boundaries
                    newX = Math.max(0, Math.min(newX, canvas.width - (draggedElement.width || 0)));
                    newY = Math.max(0, Math.min(newY, canvas.height - (draggedElement.height || 0)));

                    draggedElement.x = newX;
                    draggedElement.y = newY;
                    
                    drawCertificate();
                });
            }

            if (canvas) { // Added null check
                canvas.addEventListener('mouseup', () => {
                    if (draggedElement) {
                        draggedElement = null;
                        canvas.style.cursor = 'grab';
                        saveState();
                    }
                });
            }

            if (canvas) { // Added null check
                canvas.addEventListener('mouseout', () => {
                    if (draggedElement) {
                        draggedElement = null;
                        canvas.style.cursor = 'grab';
                        saveState();
                    }
                });
            }
            // === END DRAGGING LOGIC ===

            // Make sure the customization panel visibility reflects current view on load
            try { updateUI(); } catch (_) {}

            // --- Initial Setup ---
            window.customTemplateDefinitions = null; 

            document.fonts.ready.then(async () => {
                await loadState();
            }).catch(err => {
                console.error("Error loading fonts:", err);
                initializeDefaultState();
            });
        });
    </script>
</body>
</html>
